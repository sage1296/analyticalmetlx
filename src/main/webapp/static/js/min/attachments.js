var Attachments=function(){var d=[],b={},g={};$(function(){b=$("#attachmentsDatagrid");$("#menuAttachments").on("click",function(){showBackstage("attachments");updateActiveMenu(this);e()});g=b.find(".deleteButtonContainer").clone();b.empty();var a=function(a){jsGrid.Field.call(this,a)};a.prototype=new jsGrid.Field({sorter:function(a,c){return new Date(a)-new Date(c)},itemTemplate:function(a){return(new Date(a)).toLocaleString()},insertTemplate:function(a){return""},editTemplate:function(a){return""},
insertValue:function(){return""},editValue:function(){return""}});jsGrid.fields.dateField=a;b.jsGrid({width:"100%",height:"auto",inserting:!1,editing:!1,sorting:!0,paging:!0,noDataContent:"No attachments",controller:{loadData:function(a){var c=d;"sortField"in a&&(c=_.sortBy(c,function(c){return c[a.sortField]}),"sortOrder"in a&&"desc"==a.sortOrder&&(c=_.reverse(c)));return _.filter(c,function(a){return!a.deleted})}},pageLoading:!1,fields:[{name:"id",type:"text",title:"Download",readOnly:!0,sorting:!0,
itemTemplate:function(a,c){var b=sprintf("/attachmentProxy/%s/%s",Conversations.getCurrentConversationJid(),encodeURI(c.id));return $("<a />",{href:b,text:c.name})}},{name:"timestamp",type:"dateField",title:"When",readOnly:!0},{name:"author",type:"text",title:"Who",readOnly:!0},{name:"identity",type:"text",title:"actions",readOnly:!0,sorting:!1,itemTemplate:function(a,c){if(Conversations.shouldModifyConversation()){var b=g.clone();b.find(".deleteButton").on("click",function(){c.deleted=!0;sendStanza(c)});
return b}return $("<span/>")}}]});b.jsGrid("sort",{field:"timestamp",order:"desc"});e()});var f=function(){var a=$("#attachmentFileChoice"),b=$("#attachmentUploadFormContainer");a.wrap("<form>").closest("form").get(0).reset();a.unwrap();b.hide();Conversations.shouldModifyConversation()?($("#attachmentCreationButton").unbind("click").on("click",function(){a.click()}).show(),a.unbind("change").on("change",function(a){WorkQueue.pause();var b=Conversations.getCurrentConversationJid(),h=$(this).val().replace(/.*(\/|\\)/,
""),d=new FileReader;a=(a.target.files||a.dataTransfer.files)[0];void 0!=a?(d=new FileReader,d.onload=function(a){a=a.target.result;var c=sprintf("/uploadDataUri?filename=%s&jid=%s",encodeURI(h),b);$.ajax({url:c,type:"POST",data:a,success:function(a){a=$(a).find("resourceUrl").text();var c=UserSettings.getUsername(),b=Date.now();a={type:"file",id:a,name:h,deleted:!1,url:a,author:c,timestamp:b};Conversations.shouldModifyConversation()&&sendStanza(a);f();WorkQueue.gracefullyResume()},error:function(a){errorAlert("upload failed");
console.log("file upload failed",a);f();WorkQueue.gracefullyResume()},cache:!1,contentType:!1,processData:!1})},d.readAsDataURL(a)):(f(),WorkQueue.gracefullyResume())})):($("#attachmentCreationButton").unbind("click").hide(),a.unbind("change").hide())},k=function(){d=[];f();e()},e=function(){void 0!=WorkQueue&&WorkQueue.enqueue(function(){b.jsGrid("loadData");var a=b.jsGrid("getSorting");"field"in a&&b.jsGrid("sort",a)})},m=function(a){var b=_.partition(d,function(b){return b.id==a.id});d=_.concat(b[1],
_.reverse(_.sortBy(_.concat([a],b[0]),"timestamp"))[0])},l=function(a){try{"type"in a&&"file"==a.type&&m(a),e()}catch(b){console.log("Attachments.stanzaReceivedFunction exception",b)}};Progress.onConversationJoin.Attachments=k;Progress.historyReceived.Attachments=function(a){try{"type"in a&&"history"==a.type&&(k(),_.forEach(a.files,l),e())}catch(b){console.log("Attachments.historyReceivedFunction",b)}};Progress.stanzaReceived.Attachments=function(a){l(a)};return{getAllAttachments:function(){return d}}}();
