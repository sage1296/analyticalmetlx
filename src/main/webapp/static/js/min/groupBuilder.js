var GroupBuilder=function(){var e="byTotalGroups",g="allInHistory",h={byTotalGroups:5,byMaximumSize:4},t={},c={},u=function(a){var b=$("<div />",{"class":"groupBuilderMember",text:a.name});a.group&&"external"==a.group.type&&b.css({color:"red"});return b},y=function(){c=_.shuffle(c);p();l();m()},z=function(){console.log("Clearing %s participants",_.keys(c).length);c={};console.log("Cleared participants: %s",_.keys(c).length);var a=function(a,d){a!=Conversations.getCurrentConversation().author&&"mother"!=
a?(c[a]={name:a,enrolled:d,present:!1,participating:!1},console.log(sprintf("%s seeding as enrolled: %s (%s)",a,d,_.keys(c).length))):console.log(sprintf("%s not seeding because AUTHOR AND MOTHER DON'T GROUP",a))};_.each(Participants.getPossibleParticipants(),function(b){a(b,!0)});_.each(_.map(Participants.getParticipants(),"name"),function(b){b!=Conversations.getCurrentConversation().author&&(b in c||a(b,!1),c[b].participating=!0)});_.each(Participants.getCurrentParticipants(),function(b){b!=Conversations.getCurrentConversation().author&&
(b in c||a(b,!1),c[b].present=!0)});y();console.log("Seeded %s participants",_.keys(c).length)},v=function(a){return _.values(_.groupBy(a,function(a){return a.group?a.group.name:"unallocated"}))},w=function(a){return"allEnrolled"==g&&a.enrolled||"allInHistory"==g&&a.participating||"allPresent"==g&&a.present},l=function(){var a=_.filter(c,w),a=_.partition(a,function(a){return"group"in a}),b=a[0];if((a=a[1])&&0<a.length){var a=a[0],d=v(b),b={name:sprintf("random_%s",d.length),type:"random"};switch(e){case "byTotalGroups":var f=
parseInt(h[e]);d.length<f?(a.group=b,console.log(sprintf("%s started a new group: %s",a.name,a.group.name))):(b=_.sortBy(d,"length"),a.group=_.clone(b[0][0].group),a.group.type="random",console.log(sprintf("%s allocated to group %s of length %s",a.name,a.group.name,b[0].length)));break;case "byMaximumSize":var k=parseInt(h[e]);(d=_.find(d,function(a){return a.length<k}))?(a.group=_.clone(d[0].group),a.group.type="random",console.log("%s allocated to group %s of length %s",a.name,a.group.name,d.length)):
(a.group=b,console.log(sprintf("%s started a new group: %s",a.name,a.group.name)))}l()}else console.log("No more unallocated members")},C=function(a){var b=Conversations.getCurrentConversation().subject,d=[["anyone who has ever been here","allInHistory"],["anyone here right now","allPresent"]];"unrestricted"!=b&&d.push([sprintf("anyone enrolled in %s",b),"allEnrolled"]);_.each(d,function(b){$("<option />",{text:b[0],value:b[1]}).prop("selected",b[1]==g).appendTo(a)})},D=function(a){_.each([["there are",
"byTotalGroups"],["each has","byMaximumSize"]],function(b){$("<option />",{text:b[0],value:b[1]}).prop("selected",b[1]==e).appendTo(a)})},n=function(){var a=$("#groupsPopup");$("#groupComposition");a.find(".importGroups").empty();var b=a.find(".groups").empty(),d=Conversations.getCurrentSlide();d&&_.each(d.groupSets,function(a){_.each(_.sortBy(a.groups,"title"),function(k){var c=$("<div />",{"class":"groupBuilderGroup"}).appendTo(b).droppable({drop:function(b,c){var q=$(c.draggable).find(".groupBuilderMember").addBack(".groupBuilderMember");
console.log("Dropped",$(c.draggable),q);_.each(q,function(b){var c=$(b).text();console.log("Drop member",c);_.includes(k.members,c)||(_.each(a.groups,function(a){a.members=_.without(a.members,c)}),k.members.push(c),n(),Conversations.overrideAllocation(d))});b.preventDefault()}});$("<div />",{"class":"title",text:sprintf("Group %s",k.title)}).appendTo(c);_.each(k.members,function(a){u({name:a}).appendTo(c).draggable()})})})},E=function(a){var b=a.foreignRelationship;return b?sprintf("%s@%s",b.key,
b.system):a.name},p=function(){_.each(c,F)},A=function(a){"group"in a&&"external"==a.group.type&&delete a.group},F=function(a){"group"in a&&"random"==a.group.type&&delete a.group},G=function(){var a=$(".jAlert .groupSlideDialog").find(".importGroups").empty();$("<input />",{type:"radio",name:"groupSetSelector",id:"clearGroups"}).on("click",function(){_.each(c,A);p();l();m()}).prop("checked",!0).appendTo(a);$("<label />",{"for":"clearGroups"}).append($("<span />",{"class":"icon-txt",text:"No Smart Groups"})).appendTo(a);
_.each(t,function(b){_.each(b,function(b,f){var k=b.orgUnit;if(k){var q=$("<div />",{}).appendTo(a),e=b.groupSet,x=$("<div />",{}),g=$("<div />",{"class":"flex-container-responsive"}).appendTo(x),h=sprintf("structuralGroup_%s",f);E(e);$("<input />",{type:"radio",name:"groupSetSelector",id:h}).on("click",function(){_.each(c,A);_.each(c,function(a){_.each(b.groups,function(b,c){var d=c+1;_.includes(_.map(b.members,"name"),a.name)&&(a.group={groupSet:e.name,name:d,type:"external"})})});p();l();m()}).appendTo(g).prop("checked",
"undefined"!=typeof _.find(c,function(a){return a.group&&"external"==a.group.type&&a.group.groupSet==e.name}));$("<label />",{"for":h}).append($("<span />",{"class":"icon-txt",text:sprintf("Copy %s from %s",e.name,k.name)})).appendTo(g);var n=Conversations.getCurrentConversation().author;_.each(b.groups,function(a){var b=$("<div />",{"class":"groupBuilderGroup"}).appendTo(x);a=_.filter(a.members,function(a){return a.name!=n});0<a.length&&(x.appendTo(q),_.each(a,function(a){a=a.name;a in c||(c[a]=
{name:a,enrolled:!1,present:!1});u(c[a]).appendTo(b)}))})}})})},m=function(){var a=$(".jAlert .groupSlideDialog"),b=_.filter(c,w),d=v(b);console.log("rendering allocations:",c,b,d);var f=a.find(".groups");f.empty();_.each(d,function(a){var b=$("<div />",{"class":"groupBuilderGroup ghost"});_.each(a,function(a){var c=u(a).draggable();a.group&&"external"==a.group.type?c.prependTo(b):c.appendTo(b)});b.droppable({drop:function(b,d){b.preventDefault();var f=$(d.draggable).text();c[f].group={type:"random",
name:a[0].group.name};m()}});b.appendTo(f)})},r=function(a){$(".groupsOu.blocker").toggle(a)},B=function(a){console.log(a);$("#groupSlideDialog .importGroups").prepend("<div />",{text:a})};Progress.groupProvidersReceived.GroupBuilder=function(a){var b=$(".jAlert .ouSelector").empty();$("<option />",{text:"no groups",value:"NONE",selected:!0}).appendTo(b);_.each(a.groupsProviders,function(a){$("<option />",{text:a.displayName,value:a.storeId}).appendTo(b)});b.on("change",function(){var a=$(this).val();
if("NONE"!=a){r(!0);var b=Conversations.getCurrentConversation();console.log("finding specific groups",b);if("foreignRelationship"in b&&"system"in b.foreignRelationship&&"key"in b.foreignRelationship){var c=b.foreignRelationship.system,e=b.foreignRelationship.key;console.log("finding specific groups from foreignRelationship",b.foreignRelationship,c,e);c==a?getGroupSetsForOrgUnit(c,{ouType:"orgUnit",name:"displayName"in b.foreignRelationship?b.foreignRelationship.displayName:b.foreignRelationship.key,
members:[],groupSets:[],foreignRelationship:{system:c,key:e}},"async"):getOrgUnitsFromGroupProviders(a,"async")}else getOrgUnitsFromGroupProviders(a,"async")}})};Progress.orgUnitsReceived.GroupBuilder=function(a){"orgUnits"in a&&a.orgUnits.length||(r(!1),B(sprintf("No Org Units found for user %s",UserSettings.getUsername())))};Progress.groupSetsReceived.GroupBuilder=function(a){"groupSets"in a&&a.groupSets.length||(r(!1),B(sprintf("No Group Sets found in Org Unit %s",a.orgUnit.name)))};Progress.groupsReceived.GroupBuilder=
function(a){var b=t[a.orgUnit.name];void 0===b&&(b={},t[a.orgUnit.name]=b);var c=Conversations.getCurrentConversation().author;_.some(a.groups,function(a){return _.some(a.members,function(a){return a.name!=c})})&&(b[a.groupSet.name]=a,G());r(!1)};Progress.onBackstageShow.GroupBuilder=function(a){"groups"==a&&n();a=$("#menuGroups");$("#roomToolbar.active").length&&Conversations.shouldModifyConversation()?a.parent().show():a.parent().hide()};Progress.currentSlideJidReceived.GroupBuilder=function(){"groups"==
currentBackstage&&n()};Progress.conversationDetailsReceived.GroupBuilder=function(){"groups"==currentBackstage&&n()};return{showAddGroupSlideDialog:function(){z();getGroupsProviders();var a=$("#groupSlideDialog").clone().show();$.jAlert({title:"Add group page",width:"75%",content:a[0].outerHTML,btns:[{text:"Add page",theme:"green",closeAlert:!0,onClick:function(){var a=_.filter(c,function(a){return w(a)&&a.name!=Conversations.getCurrentConversation().author}),a=v(a),a=_.map(_.values(a),function(a){return _.map(a,
"name")});Conversations.addGroupSlide(e,parseInt(h[e]),a)}}]});var a=$(".jAlert .groupSlideDialog"),b=a.find(".strategySelect"),d=a.find(".parameterSelect"),f=a.find(".groupScope");a.find(".groups");D(b);C(f);a.find("#randomizeGroups").off("click").on("click",y);a.on("change",".groupScope",function(){g=$(this).val();console.log("Changing group scope",g);p();l();m()});a.on("change",".strategySelect",function(){e=$(this).val();console.log("Strategy set:",e);d.empty();switch(e){case "byTotalGroups":_.each(_.range(2,
10),function(a){$("<option />",{text:sprintf("%s groups in total",a),value:a.toString()}).appendTo(d)});d.val(h[e]).change();break;case "byMaximumSize":_.each(_.range(1,10),function(a){$("<option />",{text:1==a?"only one member":sprintf("at most %s members",a),value:a.toString()}).appendTo(d)}),d.val(h[e]).change()}});a.on("change",".parameterSelect",function(){h[e]=$(this).val();p();l();m()});b.val(e).change()},allocate:l,seedParticipants:z,renderAllocations:m,getParticipants:function(){return c}}}();
