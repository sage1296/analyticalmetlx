var Submissions=function(){var e=[],d,l={},f=function(){d&&0<d.length&&void 0!=WorkQueue&&WorkQueue.enqueue(function(){d.jsGrid("loadData");var a=d.jsGrid("getSorting");"field"in a&&d.jsGrid("sort",a)})};$(function(){var a=function(){d=$("#submissionsDatagrid");l=d.find(".insertOnNextSlideButtonContainer");d.empty();var a=function(a){jsGrid.Field.call(this,a)};a.prototype=new jsGrid.Field({sorter:function(a,b){return new Date(a)-new Date(b)},itemTemplate:function(a){return(new Date(a)).toLocaleString()},
insertTemplate:function(a){return""},editTemplate:function(a){return""},insertValue:function(){return""},editValue:function(){return""}});jsGrid.fields.dateField=a;var a=[{name:"url",type:"text",title:"Preview",readOnly:!0,sorting:!1,itemTemplate:function(a,b){var c=sprintf("/submissionProxy/%s/%s/%s",Conversations.getCurrentConversationJid(),b.author,b.identity);return $("<img/>",{src:c,"class":"submissionThumbnail",style:"max-height:100px;max-width:100%;cursor:zoom-in"}).on("click",function(){var a=
sprintf("/submissionProxy/%s/%s/%s",Conversations.getCurrentConversationJid(),b.author,b.identity),c=sprintf("Submission from %s at %s on page %s",b.author,new Date(b.timestamp),b.slide);$.jAlert({title:c,closeOnClick:!0,width:"90%",content:$("<img/>",{src:a})[0].outerHTML})})}},{name:"slide",type:"number",title:"Page",readOnly:!0},{name:"timestamp",type:"dateField",title:"When",readOnly:!0},{name:"author",type:"text",title:"Who",readOnly:!0}],b=[{name:"identity",type:"text",title:"actions",readOnly:!0,
sorting:!1,itemTemplate:function(a,b){var c=l.clone();c.find(".insertOnNextSlideButton").on("click",function(){addSubmissionSlideToConversationAtIndex(Conversations.getCurrentConversationJid(),Conversations.getCurrentSlide().index+1,b.identity)});return c}}];Conversations.shouldModifyConversation()&&(a=a.concat(b));d.jsGrid({width:"100%",height:"auto",inserting:!1,editing:!1,sorting:!0,paging:!0,noDataContent:"No submissions",controller:{loadData:function(a){if("sortField"in a){var b=_.sortBy(_.filter(e,
g),function(b){return b[a.sortField]});"sortOrder"in a&&"desc"==a.sortOrder&&(b=_.reverse(b));return b}return _.filter(e,g)}},pageLoading:!1,fields:a});d.jsGrid("sort",{field:"timestamp",order:"desc"});f()},b=function(){Conversations.inConversation()?a():_.delay(b,500)};b()});var g=function(a){return Conversations.shouldModifyConversation()||a.author.toLowerCase()==UserSettings.getUsername().toLowerCase()},h=function(){e=[]},k=function(a,b){try{"target"in a&&"submission"==a.target&&g(a)&&(e.push(a),
b||f())}catch(c){console.log("Submissions.stanzaReceivedFunction",c)}};Progress.onConversationJoin.Submissions=h;Progress.historyReceived.Submissions=function(a){try{"type"in a&&"history"==a.type&&(h(),_.forEach(a.submissions,function(a){k(a,!0)}),f())}catch(b){console.log("Submissions.historyReceivedFunction",b)}};return{getAllSubmissions:function(){return _.filter(e,g)},getCurrentSubmission:function(){return currentSubmission},processSubmission:k,sendSubmission:function(a){WorkQueue.pause();a=a||
function(a){a?successAlert("Submission sent","Your submission has been sent to the instructor"):errorAlert("Submission failed","This image cannot be processed, either because of image protocol issues or because it exceeds the maximum image size.")};var b=$("<canvas />"),c=board[0].width,d=board[0].height;b.width=c;b.height=d;b.attr("width",c);b.attr("height",d);b.css({width:c,height:d});var e=b[0].getContext("2d");e.fillStyle="white";e.fillRect(0,0,c,d);e.drawImage(board[0],0,0,c,d);var b=b[0].toDataURL("image/jpeg",
.4),f=(new Date).getTime(),g=UserSettings.getUsername(),l=Conversations.getCurrentSlide().id,c=Conversations.getCurrentConversation().jid,h=sprintf("submission%s%s.jpg",g,f.toString()),k=sprintf("%s:%s:%s",c,h,f),c=sprintf("/uploadDataUri?jid=%s&filename=%s",c.toString(),encodeURI(k));$.ajax({url:c,type:"POST",success:function(b){b=$(b).find("resourceUrl").text();b={audiences:[],author:g,blacklist:[],identity:k,privacy:Privacy.getCurrentPrivacy(),slide:l,target:"submission",timestamp:f,title:h,type:"submission",
url:b};console.log(b);sendStanza(b);WorkQueue.gracefullyResume();a(!0)},error:function(b){console.log(b);a(!1);WorkQueue.gracefullyResume()},data:b,cache:!1,contentType:!1,processData:!1})},requestServerSideSubmission:function(){if("Conversations"in window){var a=Conversations.getCurrentConversation(),b=Conversations.getCurrentSlideJid();"jid"in a&&submitScreenshotSubmission(a.jid.toString(),b)}},reRender:f}}();
