var Conversations=function(){var b={},f=0,g="",q=0,m=!1,w=[],F=function(){var a=!1,c=!1;return{checkIsBanned:function(b,e){var k=c,h=x(b);1==e&&(c=a=!1);!a&&h&&(c=a=!0,Progress.call("userBanned"),warningAlert("Banned","You have been banned from contributing publically to this class because you published some inappropriate content that is deemed to be contrary to the expectations of the university.\r\nThe content has been deleted on every screen, but the instructor has a record of your action.\r\nYou must contact your instructor in order to be reinstated as a contributing member of the classroom community."));
1==k&&0==h&&(a=c=!1,Progress.call("userUnbanned"),successAlert("Unbanned","The instructor has unbanned you.  You are once again permitted to contribute publicly in this class."));$("#publicMode").prop("disabled",c).toggleClass("btn-raised disabled",c);return c},reset:function(){c=a=!1}}}(),H=function(){var a={},c={},d=function(c){c in a||(a[c]={bucket:0,line:_.map(_.range(l),function(){return 0})})},e=function(c){c=c.name;d(c);a[c].bucket+=1},k=function(a){a.line.pop();a.line.unshift(a.bucket);a.bucket=
0},h,f=function(a){return a.id in c&&c[a.id].group.members.length==a.members.length},g,P=function(b){var d=Conversations.getGroupsFor(b);g=g||$("#thumbScrollContainer");var e=g.find(sprintf("#slideContainer_%s",b.id));e&&e.find(".slideThumbnailNumber").text(b.index+1);_.every(d,f)||n(b,e);_.each(d,function(b){var d=c[b.id];d&&d.update([a[b.id].line])})},l=1800;setInterval(function(){_.each(a,k)},500);setInterval(function(){d("anyPrivate");d("anyPublic");c.anyPrivate=c.anyPrivate||{};c.anyPublic=c.anyPublic||
{};h&&h.length||(h=$("#conversationActivity"));void 0!=WorkQueue&&WorkQueue.enqueue(function(){_.each(b.slides,P);0==h.find("svg").length&&(c.anyPublic.update=SparkLine.svg(h,[a.anyPublic.line,a.anyPrivate.line],50,26,1E3,1E3,500,1E3));c&&"anyPublic"in c&&"update"in c.anyPublic&&c.anyPublic.update([a.anyPublic.line,a.anyPrivate.line])})},1E3);Progress.stanzaReceived.thumbnailSparkline=function(a){if("theme"==a.type){switch(a.author){case "private":e({name:"anyPrivate"});break;case "public":e({name:"anyPublic"})}e({name:a.author})}_.each(a.audiences,
e)};var m=function(a,c,b){a.groupSets.length||(a=sprintf("/thumbnailDataUri/%s",a.id),$.ajax({url:a,beforeSend:function(a){a.overrideMimeType("text/plain; charset=x-user-defined")},dataType:"text"}).done(function(a){Date.now();void 0!=WorkQueue&&WorkQueue.enqueue(function(){b.attr("src",a)})}))},n=function(b,e){var h=e.find(".groupSlideContainer");0==h.length&&(h=$("<div />").addClass("groupSlideContainer").appendTo(e),e.addClass("groupSlide").find("img").attr("src",p));_.each(Conversations.getCurrentGroups(),
function(b){d(b.id);var e=sprintf("group_%s",b.id),k=h.find("#"+e);0==k.length&&(k=$("<div />",{id:e,"class":"thumbGroup"}).append($("<span />",{text:b.members.length,"class":"count"})).appendTo(h),b.id in c||(c[b.id]={}),c[b.id].update=SparkLine.svg(k,[a[b.id].line],80,15,1E3,1E3,500,1E3));c[b.id].group=b;k.find(".count").text(b.members.length)})},p=function(a,c){var b=$("<canvas />");b.width=a;b.height=c;b.attr("width",a);b.attr("height",c);var d=b[0].getContext("2d");d.rect(0,0,a,c);d.fillStyle=
"white";d.fill();return b[0].toDataURL()}(320,240);return{paint:function(a,c){if(a){c=c||$("#thumbScrollContainer");var b=c.find(sprintf("#slideContainer_%s",a.id));if(!a.groupSets.length){var d=b.find("img");m(a,b,d)}}},clearCache:function(){a={};c={}}}}(),Q=function(a){return!("slides"in b)||"slides"in a&&_.some(a,function(a,d){var e=b.slides[d];return e&&"id"in e&&"id"in a&&"index"in a&&"index"in e&&e.id==a.id&&e.index==a.index?!1:!0})},I=function(a,b,d){var e=b.height(),k=b.find(sprintf("#slideContainer_%s",
a.id));k.find("img");var h=k.position().top,k=h+k.height(),f=0<=k&&h<=e;0==0+e+h+k?(_.delay(function(){I(a,b,d)},1E3),f=!1):f&&d()},r=function(){if("slides"in b){var a=$("#slideContainer"),c=$("#thumbScrollContainer"),d=_.filter(b.slides,"exposed");_.each(_.filter(d,function(a){return 0==$(sprintf("#slideContainer_%s",a.id)).length}),function(b){a.append(R(b)[0])});_.each(_.filter(d,function(a){var b=_.map(d,y);$(".slideButtonContainer").filter(function(a,c){var d=$(c).attr("id");return!_.includes(b,
d)}).remove()}));var e=_.fromPairs(_.map(b.slides,function(a){return[y(a),a.index]}));$(".slideButtonContainer").sort(function(a,b){var c=$(a).attr("id"),d=$(b).attr("id");return e[c]-e[d]}).detach().appendTo(a);_.each(d,function(a){I(a,c,function(){J(a.id)})});var k=_.find(d,function(a){return a.id==f}),h=_.minBy(d,function(a){return a.index}).index,G=_.maxBy(d,function(a){return a.index}).index,g=$("#slideControls");g.empty();S(g,k.index,h);h=$("<span/>").attr("id","pageCountContainer").appendTo(g);
h.append($("<div/>").addClass("pageCounter").text(k.index+1));h.append($("<div/>").addClass("pageCounter").text("of"));h.append($("<div/>").addClass("pageCounter").text(G+1));T(g,k.index,G);U(g);V(g);p("helpButton","Help","fa-question-circle",z,g,W);A(f);$(".thumbnail:not(.groupSlide)").map(function(){var a=$(this);0>=a.width()&&(a.width(DeviceConfiguration.preferredSizes.thumbColumn.width),a.css({width:sprintf("%spx",a.width())}));a.height(.75*a.width())});Progress.call("onLayoutUpdated")}},K=function(a){var c=
b.permissions;changePermissionsOfConversation(b.jid.toString(),{studentCanOpenFriends:c.studentCanOpenFriends,studentCanPublish:a,usersAreCompulsorilySynced:c.usersAreCompulsorilySynced,studentsMayBroadcast:c.studentsMayBroadcast,studentsMayChatPublicly:c.studentsMayChatPublicly})},B=function(a){var c=b.permissions;changePermissionsOfConversation(b.jid.toString(),{studentCanOpenFriends:c.studentCanOpenFriends,studentCanPublish:c.studentCanPublish,usersAreCompulsorilySynced:a,studentsMayBroadcast:c.studentsMayBroadcast,
studentsMayChatPublicly:c.studentsMayChatPublicly})},L=function(){return b.permissions.usersAreCompulsorilySynced},t=function(){m=!0;C()},u=function(){"permissions"in b&&!l(b)&&b.permissions.usersAreCompulsorilySynced||(m=!1,C())},C=function(){m?($("#enableSync").addClass("activePrivacy active"),$("#disableSync").removeClass("activePrivacy active")):($("#enableSync").removeClass("activePrivacy active"),$("#disableSync").addClass("activePrivacy active"));$("#followTeacherCheckbox").prop("checked",
m)},D=function(a){_.find(a.slides,function(a){return a.id==f})&&(w=[],_.each(Conversations.getCurrentGroups(),function(a){_.includes(a.members,UserSettings.getUsername())&&w.push(a)}))},J=function(a){a=_.find(b.slides,["id",parseInt(a)]);H.paint(a)},M=function(){if("slides"in b&&0<f){var a=_.find(b.slides,function(a){return a.id==f}),c=_.find(b.slides,function(b){return b.index==a.index+1});void 0!=c&&"id"in c&&n(c.id.toString())}},N=function(){if("slides"in b&&0<f){var a=_.find(b.slides,function(a){return a.id==
f}),c=_.find(b.slides,function(b){return b.index==a.index-1});void 0!=c&&"id"in c&&n(c.id.toString())}},v=function(){var a=window.location.origin,b=sprintf("/join?conversation=%s&slide=%s",g,f),d=sprintf("/projector/%s",g);$("#shareLink").html($("<a/>",{href:b,text:a+b}));$("#projectorLink").html($("<a/>",{href:d,text:a+d})).on("click",bounceAnd(function(){var a=document.documentElement;(a.requestFullScreen||a.webkitRequestFullScreen||a.mozRequestFullScreen).call(a);DeviceConfiguration.setCurrentDevice("projector");
return!1}));""==g||0==f?($("#projectorViewLink").empty(),$("#slideDeepLink").empty(),$("#conversationDeepLink").empty(),$("#conversationAnalysis").empty(),$("#oneNoteExport").empty()):($("#projectorViewLink").html($("<a/>",{href:sprintf("/board?conversationJid=%s&slideId=%s&showTools=false&unique=true",g,f),text:"Project this conversation"})),$("#conversationAnalysis").html($("<a/>",{href:sprintf("/dashboard?source=%s",g),text:"Dashboard for this conversation"})),$("#slideDeepLink").html($("<a/>",
{href:sprintf("/board?conversationJid=%s&slideId=%s&unique=true",g,f),text:"DeepLink this page"})),$("#conversationDeepLink").html($("<a/>",{href:sprintf("/board?conversationJid=%s&unique=true",g),text:"Deeplink this conversation"})),$("#oneNoteExport").html($("<a/>",{href:sprintf("/saveToOneNote/%s",g),text:"Export this conversation"})));Conversations.shouldModifyConversation()?$("#editConversation").unbind("click").click(function(){$.jAlert({title:"Edit conversation",iframe:sprintf("/editConversation?conversationJid=%s&unique=true&links=false",
g),width:"100%"})}).show():$("#editConversation").unbind("click").hide()},X=function(a){var b=l(a),d=$("#studentsCanPublishCheckbox");d.off("change");d.prop("checked",a.permissions.studentCanPublish);d.prop("disabled",!b);if(b)d.on("change",function(){K(d.is(":checked"))});var e=$("#studentsMustFollowTeacherCheckbox");e.off("change");e.prop("checked",a.permissions.usersAreCompulsorilySynced);e.prop("disabled",!b);var k=$("#followTeacherCheckbox");k.off("change");k.prop("checked",m);if(b)e.on("change",
function(){B(e.is(":checked"))});else k.on("change",function(){var a=m,b=k.is(":checked");a!=b&&(b?t():u())});k.prop("disabled",a.permissions.usersAreCompulsorilySynced);b?($("#syncButtons").hide(),$(".syncCheckbox").hide()):($("#syncButtons").show(),$(".syncCheckbox").show())},Y=function(a){if(a.jid==b.jid){!l(a)&&a.permissions.usersAreCompulsorilySynced&&t();X(a);updateConversationHeader();v();C();var c=_.find(a.slides,function(a){return a.id==f}),d=_.find(a.slides,function(a){return sprintf("%s",
a.id)==q}),e=!1;if(e=c?!c.exposed:!0)(c=d||_.find(_.orderBy(a.slides,"index"),function(a){return a.exposed}))?n(c.id.toString()):window.location=sprintf("/conversationSearch?q=%s&unique=true",encodeURIComponent(a.title));Q(a)&&r();Progress.call("onLayoutUpdated")}},l=function(a){a||(a=b);return"jid"in a?"author"in a&&a.author.toLowerCase()==UserSettings.getUsername().toLowerCase()||"UserSettings"in window&&_.some(UserSettings.getUserGroups(),function(a){var b=a.name?a.name:a.value;return"special"==
(a.key?a.key:a.ouType)&&"superuser"==b})?!0:!1:!1},x=function(a){a||(a=b);return"blacklist"in a&&_.includes(a.blacklist,UserSettings.getUsername())},O=function(a){a||(a=b);var c=UserSettings.getUserGroups(),d=UserSettings.getUsername(),e=a.subject.toLowerCase().trim();a.title.toLowerCase().trim();var f=a.author,h=a.foreignRelationship;return("deleted"!=e||includeDeleted&&f==d)&&(f==d||_.some(c,function(a){var b=a.foreignRelationship,c=a.name?a.name:a.value;(a="special"==(a.key?a.key:a.ouType)&&"superuser"==
c)||void 0!==h&&"key"in h&&"system"in h&&void 0!==b&&(a=h.key==b.key&&h.system==b.system);a||(a=c.toLowerCase().trim()==e);return a}))},p=function(a,c,d,e,f,h,g){if(e(b)){a=$("<button/>",{id:a,"class":sprintf("toolbar fa %s btn-icon nmt",d),name:a,type:"button"}).append($("<div class='icon-txt'/>").text(c));f.append(a);if(void 0!==h&&(void 0==g||_.isFunction(g)&&g()))a.on("click",h);return a}},W=function(){updateConversationHeader();showBackstage("help")},Z=function(){if(l()){var a=b.jid,c=b.slides.filter(function(a){return a.id==
f})[0].index+1;addSlideToConversationAtIndex(b.jid.toString(),c);Progress.conversationDetailsReceived.JoinAtIndexIfAvailable=function(b){"jid"in b&&b.jid==a&&"slides"in b&&(b=_.find(b.slides,function(a){return a.index==c&&a.id!=f}),n(b.id.toString()))}}},z=function(){return!0},S=function(a,b,d){a=p("prevSlideButton","Prev Page","fa-angle-left",z,a,N,function(){return b!==d});b===d&&(a.addClass("disabledButton"),a.attr("disabled",!0))},U=function(a){p("addSlideButton","Add Page","fa-plus",l,a,Z,function(){return l(b)})},
V=function(a){p("addGroupSlideButton","Groups","fa-group",l,a,GroupBuilder.showAddGroupSlideDialog,function(){return l(b)})},T=function(a,b,d){a=p("nextSlideButton","Next Page","fa-angle-right",z,a,M,function(){return b!==d});b===d&&(a.addClass("disabledButton"),a.attr("disabled",!0))},E=function(){return _.find(b.slides,function(a){return a.id.toString()==f.toString()})},n=function(a,c){var d=!1;Conversations.isAuthor()?d=!0:L()?a==q&&(d=!0):d=!0;if(d)if(a!=f)try{Progress.call("beforeLeavingSlide",
[a]);f=a;A(a);delete Progress.conversationDetailsReceived.JoinAtIndexIfAvailable;loadSlide(a);if(void 0!=window&&"history"in window&&"pushState"in window.history){var e=window.location,d=b,k=E(),h=sprintf("%s//%s%s",e.protocol,e.host,e.pathname);void 0!=d&&"jid"in d&&void 0!=k&&"id"in k&&(h=sprintf("%s?conversationJid=%s&slideId=%s&unique=true&showTools=%s",h,d.jid.toString(),k.id.toString(),UserSettings.getIsInteractive().toString()));window.history.replaceState({path:h,url:h},h,h)}void 0!=k&&"id"in
k&&void 0!=document&&"title"in document&&(document.title=sprintf("MeTL - %s",k.id.toString()));D(b);Progress.call("afterJoiningSlide",[a])}catch(g){console.log(g)}else Conversations.isAuthor()&&!c&&(e={type:"command",author:UserSettings.getUsername(),audiences:[],timestamp:0,command:"/SYNC_MOVE",parameters:[a]},console.log("sending:",e),sendStanza(e));else alert("You must remain on the current page")},A=function(a){$(".slideButtonContainer").removeClass("activeSlide");a=$(sprintf("#slideContainer_%s",
a));a.addClass("activeSlide");a=a.find(".slideThumbnailNumber").text();$("#currentSlide").text(a)},y=function(a){return sprintf("slideContainer_%s",a.id)},R=function(a){var b=a.index+1,d=$("<div/>",{id:y(a),"class":"slideButtonContainer"});$("<img/>",{id:sprintf("slideButton_%s",a.id),"class":"thumbnail",alt:sprintf("Page %s",b),title:sprintf("Page %s (%s)",b,a.id)}).on("click",function(b){u();n(a.id.toString())}).appendTo(d);$("<span/>",{text:a.index+1,"class":"slideThumbnailNumber"}).appendTo($("<div/>").addClass("slide-count").appendTo(d));
return d};Progress.syncMoveReceived.Conversations=function(a){console.log("actOn",a);(Conversations.getIsSyncedToTeacher()||l(b)||!UserSettings.getIsInteractive())&&"slides"in b&&0<b.slides.filter(function(b){return b.id.toString()==a.toString()}).length&&void 0!=WorkQueue&&WorkQueue.enqueue(function(){"slides"in b&&0<b.slides.filter(function(b){return b.id.toString()==a.toString()}).length&&(q=a,n(a,!0));return!1})};Progress.conversationDetailsReceived.Conversations=function(a){try{console.log("received conversation:",
a);var c="";"jid"in b&&(c=b.jid.toString().toLowerCase());"jid"in a&&g&&a.jid.toString().toLowerCase()==g.toLowerCase()&&(O(a)?(b=a,b.jid.toString().toLowerCase()!=c&&(Progress.call("onConversationJoin"),F.checkIsBanned(a,!0),H.clearCache()),D(a)):(b={},g=""));Y(a);F.checkIsBanned(a)}catch(d){console.log("exception in actOnConversationDetails",d),updateStatus(sprintf("FAILED: ReceiveConversationDetails exception: %s",d))}Progress.call("onLayoutUpdated")};Progress.currentSlideJidReceived.Conversations=
function(a){console.log("currentSlideJid received:",a);f=a;A(a);v();D(b)};Progress.currentConversationJidReceived.Conversations=function(a){console.log("currentConversationJid received:",a);g=a;v()};$(function(){$("#thumbScrollContainer").on("scroll",_.throttle(r,500));$("#conversations").click(function(){showBackstage("conversations")});$("<div />",{text:"share",id:"shareButton","class":"icon-txt"}).on("click",bounceAnd(function(){$("#shareContainer").toggle();v()})).appendTo($("#shareButton"));
$("#closeSharingButton").on("click",bounceAnd(function(){$("#shareContainer").toggle()}));r()});return{inConversation:function(){return 0<Conversations.getCurrentConversationJid().length},isAuthor:function(){return Conversations.inConversation()?UserSettings.getUsername()==Conversations.getCurrentConversation().author:!1},getCurrentGroup:function(){return _.clone(w)},getGroupsFor:function(a){return a?_.map(_.sortBy(_.flatMap(a.groupSets,function(a){return a.groups}),"timestamp"),function(a,b){a.title=
b+1;return a}):[]},getCurrentGroups:function(){return Conversations.getGroupsFor(E())},addGroupSlide:function(a,c,d){if(l()){d=d||[];var e=b.jid,g=b.slides.filter(function(a){return a.id==f})[0].index+1;addGroupSlideToConversationAtIndex(b.jid.toString(),g,a,d,c);Progress.conversationDetailsReceived.JoinAtIndexIfAvailable=function(a){if("jid"in a&&a.jid==e&&"slides"in a){a=_.find(a.slides,function(a){return a.index==g&&a.id!=f});var b=sprintf("groupWork_%s",a.id),c=UserSettings.getUsername(),b={type:"grade",
name:sprintf("GroupSlide %s",a.id),description:"Auto generated grade for group work on group slide.",audiences:[],author:c,location:b,id:sprintf("%s_%s_%s",b,c,(new Date).getTime().toString()),gradeType:"text",visible:!1,timestamp:0};sendStanza(b);B(!0);n(a.id.toString())}}}},getCurrentTeacherSlide:function(){return q},getCurrentSlideJid:function(){return f},getCurrentSlide:E,getCurrentConversationJid:function(){return"jid"in b?b.jid.toString():g},getCurrentConversation:function(){return b},getIsSyncedToTeacher:function(){return m},
getIsSyncedToTeacherDescriptor:function(){return m?"sync on":"sync off"},getConversationModeDescriptor:function(){return b&&b.permissions&&b.permissions.studentCanPublish?"collaboration enabled":"collaboration disabled"},enableSyncMove:t,disableSyncMove:u,toggleSyncMove:function(){m?u():t()},setStudentsCanPublish:K,getStudentsCanPublish:function(){return b.permissions.studentCanPublish},setStudentsMustFollowTeacher:B,getStudentsMustFollowTeacher:L,shouldDisplayConversation:O,shouldPublishInConversation:function(a){a||
(a=b);return l(a)||"permissions"in a&&"studentCanPublish"in a.permissions&&a.permissions.studentCanPublish&&!x(a)?!0:!1},shouldModifyConversation:l,overrideAllocation:function(a){l()&&overrideAllocation(Conversations.getCurrentConversationJid(),a)},goToNextSlide:M,goToPrevSlide:N,goToSlide:n,updateThumbnail:J,getIsBanned:x,refreshSlideDisplay:r}}();function updateThumb(b){Conversations.updateThumbnail(b)}function unwrap(b){return _.map(b,"0")}
function receiveCurrentSlide(b){Progress.call("currentSlideJidReceived",[b])}function receiveCurrentConversation(b){Progress.call("currentConversationJidReceived",[b])}function receiveConversationDetails(b){Progress.call("conversationDetailsReceived",[b])}function receiveSyncMove(b){(Conversations.getIsSyncedToTeacher()||Conversations.shouldModifyConversation())&&Progress.call("syncMoveReceived",[b])}function receiveNewConversationDetails(b){Progress.call("newConversationDetailsReceived",[b])}
function receiveConversations(b){Progress.call("conversationsReceived",[b])}function receiveAttendance(b){Progress.call("attendanceReceived",[b])}function receiveGroupsProviders(b){Progress.call("groupProvidersReceived",[b])}function receiveOrgUnitsFromGroupsProviders(b){Progress.call("orgUnitsReceived",[b]);"orgUnits"in b&&b.orgUnits.length&&_.forEach(b.orgUnits,function(f){f=_.cloneDeep(f);delete f.groupSets;delete f.members;getGroupSetsForOrgUnit(b.groupsProvider.storeId,f,"async")})}
function receiveGroupSetsForOrgUnit(b){Progress.call("groupSetsReceived",[b]);"groupSets"in b&&b.groupSets.length&&_.forEach(b.groupSets,function(f){if("groups"in f&&f.groups.length)receiveGroupsForGroupSet({orgUnit:b.orgUnit,groupSet:f,groups:f.groups});else{var g=_.cloneDeep(b.orgUnit);delete g.members;delete g.groupSets;f=_.cloneDeep(f);delete f.members;delete f.groups;getGroupsForGroupSet(b.groupsProvider.storeId,g,f,"async")}})}
function receiveGroupsForGroupSet(b){Progress.call("groupsReceived",[b])};
