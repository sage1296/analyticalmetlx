var Quizzes=function(){var h={},q={},u={},x={},e={},B={},C={},D={},E={},k=void 0,m=function(){void 0!=WorkQueue&&WorkQueue.enqueue(function(){e.jsGrid("loadData");var a=e.jsGrid("getSorting");"field"in a&&e.jsGrid("sort",a)})},v=function(a){return sprintf("/quizProxy/%s/%s",Conversations.getCurrentConversationJid(),a)};$(function(){e=$("#quizDatagrid");B=e.find(".editQuizPopup").clone();C=e.find(".answerQuizPopup").clone();D=e.find(".viewResultsPopup").clone();E=e.find(".actionsButtons").clone();
e.empty();var a=function(a){jsGrid.Field.call(this,a)};a.prototype=new jsGrid.Field({sorter:function(a,c){return new Date(a)-new Date(c)},itemTemplate:function(a){return(new Date(a)).toLocaleString()},insertTemplate:function(a){return""},editTemplate:function(a){return""},insertValue:function(){return""},editValue:function(){return""}});jsGrid.fields.dateField=a;var b=function(a){var c=h[a.key],b=sprintf("Results for %s",c.question),f=sprintf("quizResultsPopup_%s",c.id),y=$("<div/>",{id:f}),e=$.jAlert({title:b,
width:"auto",content:y[0].outerHTML,onClose:function(a){k=void 0}});k=function(b){if(b==a.key){b=D.clone();b.find(".quizQuestion").text(c.question);var d=sprintf("quizResultsPopupGraph_%s",c.id),n=$(u[a.key]).clone();b.find(".quizResultsGraph").attr("id",d).append(n.clone()).css({width:"45%"});d=b.find(".quizImagePreview").css({"max-width":"45%"});d.attr("src",v(c.id));"url"in c?d.show():d.hide();var d=b.find(".quizOptionContainer"),l=d.find(".quizOption"),r=w(c),z=function(a,c){var b=0;a.id in q&&
$.each(r,function(a,l){l.latestAnswer.answer.toLowerCase()!=c.name.toLowerCase()||!Conversations.shouldModifyConversation()&&a.toLowerCase()!=UserSettings.getUsername().toLowerCase()||(b+=1)});return b},t=_.size(r),y=.5*t,h=.25*t;d.html(_.map(c.options,function(a){var b=l.clone();b.find(".quizOptionName").text(a.name);b.find(".quizOptionText").text(a.text);var d=b.find(".quizOptionMeter");Conversations.shouldModifyConversation()?(a=z(c,a),b.find(".quizOptionAnswerCount").text(a),d.attr("value",a).attr("min",
0).attr("max",t).attr("low",h).attr("high",y).attr("optimum",t).text(sprintf("%s out of %s",a,t))):(b.find(".quizOptionCountContainer").remove(),d.remove());return b}));var F=function(a){var b=n.clone()[0],b=(new XMLSerializer).serializeToString(b),c=(new Date).getTime(),l=UserSettings.getUsername(),d=Conversations.getCurrentConversation(),l=sprintf("quizresultsimage%s%s.jpg",l,c.toString()),c=sprintf("%s:%s:%s",d.jid.toString(),l,c),d=sprintf("/uploadSvg?jid=%s&filename=%s&width=%s&height=%s",d.jid.toString(),
encodeURI(c),640,480);$.ajax({url:d,type:"POST",success:function(b){b=$(b).find("resourceUrl").text();a(b,640,480)},error:function(a){console.log("exception while adding the quizResultsGraph to the slide",a)},data:b,cache:!1,contentType:!1,processData:!1})},k=function(a,b){return{bold:!1,color:["#000000",255],font:"sans-serif",italic:!1,justify:"left",size:b,text:sprintf("%s\n",a),underline:!1}},m=function(a){var b=_.map(c.options,function(a){return k(sprintf("%s: %s",a.name,a.text),18)});b.unshift(k(c.question,
24));b.push(k("\n",24));return{author:UserSettings.getUsername(),timestamp:-1,target:"presentationSpace",tag:"_",privacy:"PUBLIC",slide:a,identity:sprintf("%s_%s_%s",UserSettings.getUsername(),Date.now(),_.uniqueId()),type:"multiWordText",x:g.left,y:g.bottom+480,requestedWidth:640,width:640,height:480,words:b,audiences:[]}};b.find(".quizResultsShouldDisplayOnSlide").unbind("click").on("click",function(){F(function(a,b,c){var l=Conversations.getCurrentSlideJid(),d=UserSettings.getUsername(),r=(new Date).getTime(),
f=sprintf("%s%s%s",l,d,r);sendStanza({type:"image",author:d,height:c,width:b,identity:f,slide:l,source:a,privacy:"PUBLIC",tag:f,target:"presentationSpace",timestamp:r,x:g.left,y:g.top});sendStanza(m(l));e.closeAlert();hideBackstage()})});b.find(".quizResultsShouldDisplayOnNextSlide").unbind("click").on("click",function(){F(function(a,b,c){b=Conversations.getCurrentConversationJid();c=Conversations.getCurrentSlide().index+1;addImageSlideToConversationAtIndex(b,c,a,m("0"));e.closeAlert();hideBackstage()})});
$("#"+f).html(b)}};k(a.key)};e.jsGrid({width:"100%",height:"auto",inserting:!1,editing:!1,sorting:!0,paging:!0,noDataContent:"No polls",controller:{loadData:function(a){var b=_.map(_.filter(h,function(a){return 0==a.isDeleted}),"id"),b=_.map(b,function(a){var b=h[a],c=q[a];u[a]=G(b,640,480);return{key:a,question:b.question,author:b.author,created:b.created,id:b.id,answerCount:_.size(c),answers:c,timestamp:b.timestamp,url:b.url,optionCount:_.size(b.options),options:b.options}});"sortField"in a&&(b=
_.sortBy(b,function(b){return b[a.sortField]}),"sortOrder"in a&&"desc"==a.sortOrder&&(b=_.reverse(b)));return b}},pageLoading:!1,fields:[{name:"question",type:"text",title:"Question",readOnly:!0},{name:"optionCount",type:"number",title:"Options",readOnly:!0},{name:"url",type:"text",title:"Image",readOnly:!0,itemTemplate:function(a,b){return a?$("<img/>",{src:v(b.id),style:"width:120px;height:90px"}):$("<span/>")}},{name:"created",type:"dateField",title:"Created",readOnly:!0},{name:"timestamp",type:"dateField",
title:"Modified",readOnly:!0},{name:"answerCount",type:"number",title:"Answers",readOnly:!0,itemTemplate:function(a,c){var d=h[c.key];if(Conversations.shouldModifyConversation())return d=$("<div/>"),d.append(u[c.key]),d.css({width:"100%",height:"100%"}),d.on("click",function(){b(c)}),d;d=w(d)[UserSettings.getUsername()];return void 0!=d&&"latestAnswer"in d?$("<span/>",{text:d.latestAnswer.answer}):$("<span/>",{text:"unanswered"})}},{name:"id",type:"text",title:"Actions",readOnly:!0,sorting:!1,itemTemplate:function(a,
c){var d=h[c.key],f=E.clone(),e=f.find(".editPollButton"),g=f.find(".answerPollButton"),k=f.find(".viewAnswersButton");g.on("click",function(){var a=sprintf("Answer poll: %s",d.question),b=sprintf("quiz_answer_%s",d.id),l=$("<span/>",{id:b}),r=$.jAlert({title:a,closeOnClick:!0,width:"auto",content:l[0].outerHTML});sprintf("answerContainer_%s",d.id);a=C.clone();$("#"+b).append(a);a.find(".quizOptionCount").text(c.optionCount);a.find(".quizOptionCountPluralizer").text(1==c.optionCount?"":"s");var b=
a.find(".quizOptionContainer"),z=b.find(".quizOption").clone();b.html(_.map(d.options,function(a){var b=z.clone();b.find(".quizOptionButton").on("click",function(){answerQuiz(Conversations.getCurrentConversationJid(),d.id,a.name);r.closeAlert()});b.find(".quizOptionName").text(a.name);b.find(".quizOptionText").text(a.text);return b}));b=a.find(".quizImagePreview");b.attr("src",v(d.id));"url"in d?b.show():b.hide()});Conversations.shouldModifyConversation()?(e.on("click",function(){H(d)}),k.on("click",
function(){b(c)})):(e.remove(),k.remove());return f}}]});e.jsGrid("sort",{field:"name",order:"desc"});m()});var H=function(a){var b=_.cloneDeep(a),e=sprintf("edit_quiz_%s",a.id),c=$("<span/>",{id:e}),d=sprintf("Edit poll: %s",a.question),f=$.jAlert({title:d,width:"90%",content:c[0].outerHTML}),c=B.clone();c.find(".quizQuestion").val(a.question).on("change",function(){b.question=$(this).val()});var g=c.find(".quizOptionContainer"),h=g.find(".quizOption"),k=function(a){var c=h.clone();c.find(".quizOptionName").text(a.name);
c.find(".quizOptionText").val(a.text).on("change",function(){a.text=$(this).val()});c.find(".quizOptionDelete").on("click",function(){b.options=_.filter(b.options,function(b){return b.name!=a.name});c.remove()});return c};g.html(_.map(b.options,k));c.find(".addOptionButton").on("click",function(){var a="A",c=_.reverse(_.orderBy(b.options,"name"));0<c.length&&(a=c[0].name,a=/^z+$/.test(a)?a.replace(/z/g,"a")+"a":a.slice(0,-1)+String.fromCharCode(a.slice(-1).charCodeAt()+1));a={type:"quizOption",name:a,
text:"",correct:!1,color:Colors.getColorForSeed(a)};b.options.push(a);a=k(a);g.append(a);a=a.find(".quizOptionText")[0];a.scrollIntoView();a.focus()});var p=c.find(".quizImagePreview");p.attr("src",v(b.id));"url"in b?p.show():p.hide();var n=c.find(".removeSlideImageFromQuiz");n.on("click",function(){p.attr("src",void 0).hide();n.hide();b.url=void 0});"url"in b?n.show():n.hide();c.find(".addSlideImageToQuiz").on("click",function(){WorkQueue.pause();var a=Conversations.getCurrentConversation(),c=$("<canvas />"),
d=board[0].width,e=board[0].height;c.width=d;c.height=e;c.attr("width",d);c.attr("height",e);c.css({width:d,height:e});var f=c[0].getContext("2d");f.fillStyle="white";f.fillRect(0,0,d,e);f.drawImage(board[0],0,0,d,e);var g=c[0].toDataURL("image/jpeg",.4),c=(new Date).getTime(),d=UserSettings.getUsername(),d=sprintf("quizimage%s%s.jpg",d,c.toString()),c=sprintf("%s:%s:%s",a.jid.toString(),d,c),a=sprintf("/uploadDataUri?jid=%s&filename=%s",a.jid.toString(),encodeURI(c));$.ajax({url:a,type:"POST",success:function(a){a=
$(a).find("resourceUrl").text();b.url=a;p.attr("src",g).show();n.show();WorkQueue.gracefullyResume()},error:function(a){console.log("exception while snapshotting the slide for the quizImage",a);WorkQueue.gracefullyResume()},data:g,cache:!1,contentType:!1,processData:!1})});c.find(".updateQuiz").on("click",function(){sendStanza(b);f.closeAlert()});c.find(".deleteQuiz").on("click",function(){b.isDeleted=!0;sendStanza(b);f.closeAlert()});$("#"+e).append(c)},I=function(){h={};q={};Conversations.shouldModifyConversation()?
$("#quizCreationButton").unbind("click").on("click",function(){var a=(new Date).getTime(),b=UserSettings.getUsername(),e=sprintf("%s",a),a={type:"quiz",options:[{type:"quizOption",name:"A",text:"",correct:!1,color:Colors.getColorForSeed("A")},{type:"quizOption",name:"B",text:"",correct:!1,color:Colors.getColorForSeed("B")},{type:"quizOption",name:"C",text:"",correct:!1,color:Colors.getColorForSeed("C")}],question:"",author:b,created:a,id:e,isDeleted:!1,timestamp:a,audiences:[]};H(a)}).show():$("#quizCreationButton").unbind("click").hide()},
w=function(a){if(void 0!==a&&"type"in a&&"quiz"==a.type&&"id"in a){var b={};$.each(q[a.id]||[],function(a,c){if(Conversations.shouldModifyConversation()||c.author.toLowerCase()==UserSettings.getUsername().toLowerCase())b[c.answerer]={latestAnswer:c,answerCount:(b[c.answerer]||{answerCount:0}).answerCount+1}});return b}return{}},g={left:30,right:30,top:30,bottom:30},G=function(a,b,e){var c=w(a),d=function(a,b){var d=0;a.id in q&&$.each(c,function(a,c){c.latestAnswer.answer.toLowerCase()!=b.name.toLowerCase()||
!Conversations.shouldModifyConversation()&&a.toLowerCase()!=UserSettings.getUsername().toLowerCase()||(d+=1)});return d},f=_.map(a.options,function(b){return{name:b.name,score:d(a,b),color:b.color}}),k=document.createElementNS("http://www.w3.org/2000/svg","svg"),h=d3.select(k).attr("width","100%").attr("height","100%").attr("viewBox","0 0 "+b+" "+e),m=d3.scaleBand().padding(.1).range([g.left,b-g.right]).domain(_.map(f,"name")),p=d3.scaleLinear().range([g.top,e-g.bottom]).domain([_.max(_.map(f,"score"))+
1,0]);b=d3.axisBottom(m);var n=d3.axisLeft(p);h.append("g").attr("transform",sprintf("translate(0,%s)",e-g.bottom)).call(b);h.append("g").attr("transform",sprintf("translate(%s,0)",g.left)).call(n);h.append("g").selectAll("rect").data(f).enter().append("rect").attr("x",function(a,b){return m(a.name)}).attr("class","bar").style("fill",function(a,b){return a.color[0]}).attr("y",function(a){return p(a.score)}).attr("height",function(a){return e-p(a.score)-g.bottom}).attr("width",m.bandwidth());return k},
A=function(a){try{if(void 0!==a&&"type"in a&&"quizResponse"==a.type){var b=q[a.id];b?b[_.size(b)]=a:b=[a];q[a.id]=b;a.id in h&&(u[a.id]=G(h[a.id],640,480),void 0!=k&&k(a.id))}else void 0!==a&&"type"in a&&"quiz"==a.type&&(h[a.id]=a,x.id==a.id&&(x=a))}catch(e){console.log("Quizzes.stanzaReceivedFunction exception",e)}};Progress.onConversationJoin.Quizzes=I;Progress.historyReceived.Quizzes=function(a){try{void 0!==a&&"type"in a&&"history"==a.type&&(I(),_.forEach(a.quizResponses,A),_.forEach(a.quizzes,
A),m())}catch(b){console.log("Quizzes.historyReceivedFunction",b)}};Progress.stanzaReceived.Quizzes=function(a){A(a);m()};return{getCurrentQuiz:function(){return x},getAllQuizzes:function(){return h},getAnswersForQuiz:w,reRender:m}}();
