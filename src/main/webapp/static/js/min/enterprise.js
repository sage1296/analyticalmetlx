var Enterprise=function(){var y=function(b){b=_.clone(b);b.timestamp=864E5*Math.floor(b.timestamp/864E5);return b},C=function(b){b=_.groupBy(b,function(b){return y(b).timestamp});for(var k=_.map(_.keys(b),function(b){return parseInt(b)}),d=_.min(k),k=_.max(k);d<k;d+=864E5)d in b||(b[d]=[]);return _.sortBy(_.toPairs(b),function(b){return b[0]})},x=function(b){function k(a){a=a.parameters;return _.isArray(a)?a[0]:a}function d(a){return(d3.timeSecond(a)<a?x:d3.timeMinute(a)<a?D:d3.timeHour(a)<a?E:d3.timeDay(a)<
a?F:d3.timeMonth(a)<a?d3.timeWeek(a)<a?G:H:d3.timeYear(a)<a?I:J)(a)}$("#vis").empty();var h=$("#vis").width()-35-25,c=[35,h-25],q=d3.scaleTime().range(c),f=d3.scaleTime().range(c),r=d3.scaleBand().range(c).padding(.1).align(0),m=d3.scaleLinear().range([10,275]),t=d3.scaleLinear().range([150,15]),u=d3.scaleLinear().range([150,15]),z=d3.scaleLinear().range([0,35]),c=_.groupBy(b,function(a){return parseInt(a.timestamp)>(new Date(2014,6,15)).getTime()}),A=_.keys(_.groupBy(c[!1],k)).length;b=c[!0];var c=
_.groupBy(b,k),c=_.sortBy(_.flatMap(c,function(a){a=_.map(a,y);return[{timestamp:a[0].timestamp,creation:[a[0]],update:[]}].concat(_.map(a.slice(1),function(a){return{timestamp:a.timestamp,creation:[],update:[a]}}))}),"timestamp"),e=_.reduce(c,function(a,b){var c=b.timestamp;c in a||(a[c]={timestamp:c,creation:0,update:0});c=a[c];c.creation+=b.creation.length;c.update+=b.update.length;return a},{}),n=d3.stack().keys(["creation","update"])(_.values(e)),c=_.reduce(c,function(a,b){var c=b.timestamp;
a.total+=b.creation.length;a[c]={timestamp:c,conversations:a.total};return a},{total:0});delete c.total;c=_.toPairs(c);e=_.sortBy(_.map(e,"timestamp"));e=d3.extent(e);q.domain(e);f.domain(e);var l=C(b);t.domain([0,_.max(l.map(function(a){return a[1].length}))]);u.domain([0,c[c.length-1][1].conversations]);m.domain([_.max(_.map(l,function(a){return a[1].length})),0]);e=_.map(l,function(a){return _.uniq(_.map(a[1],"author"))});e=_.map(e,"length");z.domain(d3.extent(e));b=d3.select("#ep").selectAll(".authorLine").data(_.sortBy(_.toPairs(_.groupBy(b,
"author")),function(a){return a[1].length}).reverse()).enter().append("tr").attr("class","authorLine").attr("y",function(a,b){return 25*b});b.append("th").text(function(a){return a[0]});b.append("td").text(function(a){return a[1].length});b=b.append("td").append("svg:svg").attr("width",h+35+25).attr("height",20).append("g").attr("transform","translate(10,0)");b.selectAll(".span").data(function(a){return[_.map(a[1],function(a){return parseInt(a.timestamp)})]}).enter().append("rect").attr("class","span").attr("width",
function(a){console.log(a);return f(_.max(a))-f(_.min(a))}).attr("height",3).attr("x",function(a){return f(_.min(a))}).attr("y",8);b.selectAll(".circ").data(function(a){return a[1]}).enter().append("circle").attr("class","circ").attr("cx",function(a){return f(a.timestamp)}).attr("cy",9).attr("r",6);var x=d3.timeFormat(".%L"),D=d3.timeFormat(":%S"),E=d3.timeFormat("%I:%M"),F=d3.timeFormat("%I %p"),G=d3.timeFormat("%a %d"),H=d3.timeFormat("%b %d"),I=d3.timeFormat("%b"),J=d3.timeFormat("%Y"),B=d3.axisBottom(q).tickSize(-300,
0).tickFormat(d),w=d3.axisLeft(m).tickSizeInner(-h);b=d3.axisBottom(f).tickFormat(d);var e=d3.axisLeft(t).tickSizeInner(0),g=d3.select("#vis").append("svg").attr("width",h+35+25).attr("height",485).append("g").attr("class","context").attr("transform","translate(35,10)"),p=g.append("g"),K=d3.brushX().on("brush",function(){q.domain(d3.event.selection.map(f.invert,f));var a=q.domain();r.domain(_.filter(_.map(l,"0"),function(b){return b>=a[0]-432E5&&b<=a[1]+432E5}));p.select(".x.axis").call(B);d3.selectAll(".tick").selectAll("text").call(function(a){console.log("tick",
a)}).attr("y",9);p.selectAll("rect").attr("x",function(a){return a.data.timestamp}).attr("y",function(a){return m(a[1])+10}).attr("width",r.bandwidth())});r.domain(_.map(l,"0"));var v=d3.scaleOrdinal(d3.schemeCategory10);p.append("g").selectAll("serie").data(n).enter().append("g").attr("class","serie").attr("fill",function(a,b){return v(b)}).selectAll("rect").data(function(a){return a}).enter().append("rect").attr("x",function(a){return q(a.data.timestamp)-r.bandwidth()/2}).attr("y",function(a){return m(a[1])+
10}).attr("height",function(a){return m(a[0])-m(a[1])}).attr("width",r.bandwidth());p.append("g").attr("class","x axis").attr("transform","translate(35,295)").call(B);p.append("g").attr("class","y axis").attr("transform","translate(35,10)").call(w);n=p.append("g").attr("class","detailLegend").attr("transform","translate(50,20)").selectAll(".legendLine").data([{text:"New conversations",color:v(0)},{text:"Conversation edits",color:v(1)},{text:"Total conversations",color:v(2)},{text:"Total activity",
color:"blue"}]).enter().append("g").attr("class","legendLine").attr("transform",function(a,b){return"translate(0,"+35*b+")"});n.append("rect").attr("height",30).attr("width",30).attr("fill",function(a){return a.color});n.append("text").text(function(a){return a.text}).attr("x",35).attr("y",20);var n=d3.area().x(function(a){return f(a[0])}).y0(t(0)).y1(function(a){return t(a[1].length)}),w=d3.axisRight(u),L=d3.area().x(function(a){return f(a[0])}).y0(u(A)).y1(function(a){return u(A+a[1].conversations)}),
g=g.append("g");g.attr("transform","translate(0,300)");g.append("g").attr("transform","translate(35,150)").call(b);g.append("g").attr("class","totalsArea").append("path").attr("d",L(c));g.append("g").attr("class","masterArea").call(K).append("path").attr("d",n(l));g.append("g").attr("class","teachers").selectAll(".circ").data(l).enter().append("circle").attr("class","circ").attr("cx",function(a){return f(a[0])}).attr("cy",function(a){return t(a[1].length)}).attr("r",function(a){return z(_.uniq(_.map(a[1],
"author")).length)});g.append("g").attr("transform","translate(35,0)").call(e);g.append("g").attr("transform","translate("+(h-25)+",0)").call(w);h=g.append("g").attr("transform","translate(50,20)").selectAll(".legendLine").data([{text:"Distinct authors","class":"circ"}]).enter().append("g").attr("transform",function(a,b){return"translate(0,"+35*b+")"});h.append("circle").attr("class","circ").attr("cx",15).attr("cy",15).attr("r",15);h.append("text").text(function(a){return a.text}).attr("class","legendLine").attr("x",
35).attr("y",20)};return{prime:function(){$.get("/describeConversations?query=&format=json",function(b){b=_.flatMap(b.conversations,function(b){var d=_.map(b.edits,function(d){return{timestamp:d,author:b.author,command:"/UPDATE_CONVERSATION_DETAILS",parameters:[b.jid]}}),d=_.sortBy(d,"timestamp");console.log(b,_.map(d,function(b){return new Date(b.timestamp)}));return d});x(b)})}}}();$(Enterprise.prime);
