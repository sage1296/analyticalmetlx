(function(){for(var b=0,a=["ms","moz","webkit","o"],c=0;c<a.length&&!window.requestAnimationFrame;++c)window.requestAnimationFrame=window[a[c]+"RequestAnimationFrame"],window.cancelRequestAnimationFrame=window[a[c]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(a,d){var c=(new Date).getTime(),f=Math.max(0,16-(c-b)),e=window.setTimeout(function(){a(c+f)},f);b=c+f;return e});window.cancelAnimationFrame||(window.cancelAnimationFrame=function(a){clearTimeout(a)})})();
var reapplyStylingToServerGeneratedContent=function(b){$("#"+b).find(".simpleMultipleButtonInteractableMessageButton a").addClass("button-transparent-border button")},bounceAnd=function(b){return function(a){b(a)}};function updateStatus(b){$("#status").text(b)}var noActiveBackstage="none",flash=function(b){b.fadeOut(100).fadeIn(100)};function updateActiveMenu(b){$(".activeBackstageTab").removeClass("activeBackstageTab active");$(b).addClass("activeBackstageTab active")}
var WorkQueue=function(){var b=!0,a=[],c=!1,h=function(){var d=a.pop();d?(c=c||d(),h()):c&&(blit(),c=!1)},d=void 0;return{pause:function(){d&&(window.clearTimeout(d),d=void 0);b=!1;Progress.call("afterWorkQueuePause")},gracefullyResume:function(){d&&(window.clearTimeout(d),d=void 0);d=setTimeout(function(){b=!0;h()},1E3);Progress.call("beforeWorkQueueResume")},enqueue:function(d){b?d()&&blit():a.push(function(){return d()})}}}(),Pan={pan:function(b,a){takeControlOfViewbox(!0);var c=scale();TweenController.panViewboxRelative(b/
c,a/c)},translate:function(b,a){takeControlOfViewbox(!0);var c=scale();TweenController.translateViewboxRelative(b/c,a/c)}},Zoom=function(){var b=function(a){var c=3*boardContent.width,b=3*boardContent.height,d=.1*boardWidth,v=.1*boardHeight,f=void 0,e=void 0,g=void 0,l=void 0;"width"in a&&(f=a.width,f>c&&(f=c),f<d&&(f=d));"height"in a&&(e=a.height,e>b&&(e=b),e<v&&(e=v));"x"in a&&(g=a.x,f!=a.width&&(g+=(a.width-f)/2));"y"in a&&e&&(l=a.y,e!=a.height&&(l+=(a.height-e)/2));return{width:f,height:e,x:g,
y:l}};return{scale:function(a,c){takeControlOfViewbox(!0);var h=viewboxWidth*a,d=viewboxHeight*a;c||(d=b({height:d,width:h}),h=d.width,d=d.height);TweenController.scaleAndTranslateViewbox((viewboxWidth-h)/2+viewboxX,(viewboxHeight-d)/2+viewboxY,h,d)},zoom:function(a,c,h){takeControlOfViewbox(!0);var d=viewboxWidth*a;a*=viewboxHeight;c||(c=b({height:a,width:d}),d=c.width,a=c.height);d-=viewboxWidth;c=a-viewboxHeight;TweenController.zoomAndPanViewboxRelative(d/2*-1,c/2*-1,d,c,h)},out:function(){Zoom.zoom(1.2)},
"in":function(){Zoom.zoom(1/1.2)},constrainRequestedViewbox:b}}(),TweenController=function(){var b=function(d,b,f,e,g,l){isNaN(d)||isNaN(b)||isNaN(f)||isNaN(e)?g&&g():(c&&c.stop(),c=!1,viewboxX=d,viewboxY=b,viewboxWidth=f,viewboxHeight=e,l||(requestedViewboxX=viewboxX,requestedViewboxY=viewboxY,requestedViewboxWidth=viewboxWidth,requestedViewboxHeight=viewboxHeight),g&&g(),blit(),a(d,b,f,e),Progress.call("onViewboxChanged"))},a=_.throttle(function(d,b,a,c){Conversations.isAuthor()&&UserSettings.getIsInteractive()&&
(d=[d,b,a,c,Date.now(),Conversations.getCurrentSlideJid(),"autoZooming"in Progress.onBoardContentChanged],0>=a||0>=c||_.some(d,function(d){return"undefined"==typeof d||isNaN(d)})||sendStanza({author:UserSettings.getUsername(),timestamp:Date.now(),type:"command",command:"/TEACHER_VIEW_MOVED",parameters:d.map(function(d){return d.toString()})}))},300),c,h=function(d,b,f,e,g,l,w){if(isNaN(d)||isNaN(b)||isNaN(f)||isNaN(e))g&&g();else{var x=viewboxX,n=viewboxY,h=viewboxWidth,u=viewboxHeight,p=d-x,q=b-
n,k=f-h,r=e-u;c&&(c.stop(),c=!1);c=(new TWEEN.Tween({x:0,y:0,w:0,h:0})).to({x:p,y:q,w:k,h:r},300).easing(TWEEN.Easing.Quadratic.Out).onUpdate(function(){viewboxX=x+this.x;viewboxY=n+this.y;viewboxWidth=h+this.w;viewboxHeight=u+this.h}).onComplete(function(){c=!1;viewboxX=d;viewboxY=b;viewboxWidth=f;viewboxHeight=e;blit();l||(requestedViewboxX=viewboxX,requestedViewboxY=viewboxY,requestedViewboxWidth=viewboxWidth,requestedViewboxHeight=viewboxHeight);g&&g();Progress.call("onViewboxChanged");Progress.call("textBoundsChanged")}).start();
var m=function(d){c&&(TWEEN.update(),blit(),requestAnimationFrame(m))};requestAnimationFrame(m);"Conversations"in window&&Conversations.isAuthor()&&!w&&!l&&void 0!=d&&void 0!=b&&0<f&&0<e&&(0!=p||0!=q||0!=k||0!=r)&&a(d,b,f,e)}};return{panViewbox:function(d,b,a,c){return h(d,b,viewboxWidth,viewboxHeight,a,c)},translateViewbox:function(d,a,c,e){return b(d,a,viewboxWidth,viewboxHeight,c,e)},zoomAndPanViewbox:function(d,b,a,c,g,l,w){return h(d,b,a,c,g,l,w)},scaleAndTranslateViewbox:function(d,a,c,e,g,
l){return b(d,a,c,e,g,l)},panViewboxRelative:function(d,b,a,c){return h(d+viewboxX,b+viewboxY,viewboxWidth,viewboxHeight,a,c)},translateViewboxRelative:function(d,a,c,e){return b(d+viewboxX,a+viewboxY,viewboxWidth,viewboxHeight,c,e)},zoomAndPanViewboxRelative:function(b,a,c,e,g,l){return h(b+viewboxX,a+viewboxY,c+viewboxWidth,e+viewboxHeight,g,l)},scaleAndTranslateViewboxRelative:function(a,c,f,e,g,l){return b(a+viewboxX,c+viewboxY,f+viewboxWidth,e+viewboxHeight,g,l)},immediateView:function(){return[viewboxX,
viewboxY,viewboxX+viewboxWidth,viewboxY+viewboxHeight]}}}(),Extend=function(){return{up:function(){TweenController.panViewboxRelative(0,-Math.floor(.6*viewboxHeight))},down:function(){TweenController.panViewboxRelative(0,Math.floor(.6*viewboxHeight))},left:function(){TweenController.panViewboxRelative(-Math.floor(.6*viewboxWidth),0)},right:function(){TweenController.panViewboxRelative(Math.floor(.6*viewboxWidth),0)},shift:TweenController.panViewboxRelative,center:function(b,a,c){TweenController.panViewboxRelative(b-
viewboxWidth/2-viewboxX,a-viewboxHeight/2-viewboxY,c)}}}(),subcategoryMapping={metaToolbar:".metaConversationGroup",roomToolbar:".inConversationGroup",optsToolbar:".applicationGroup"},categoryMapping=_.fromPairs(_.flatMap({metaToolbar:"integrations print recycleBin help",optsToolbar:"settings healthCheck",roomToolbar:"grades blacklist submissions attachments participants groups quizzes contentFilter"},function(b,a){return _.map(b.split(" "),function(b){return[b,a]})})),active="activeBackstageTab active";
function showBackstage(b){$("html").css("overflow-y","auto");$("#masterFooter").hide();window.currentBackstage=b;$(".backstage").hide();"HealthCheckViewer"in window&&HealthCheckViewer.pause();$(".backstageTabHeaderGroup").hide();$(".backstageTabHeader").removeClass(active);$(".backstageCategory").removeClass("active");$(".backstageCategory").removeClass(active);$(".modeSpecificTool").removeClass(active);$(".backstage").removeClass(active);var a=$("#"+b+"Popup"),c=categoryMapping[b];$(subcategoryMapping[c]).show();
$("#backstageContainer").css("overflow-y","scroll").show();$("#hideBackstage").show();a.show();$("#applicationMenuPopup").addClass("active");$("#applicationMenuButton").addClass(active);$(".modeSpecificTool."+b).addClass(active);$("#"+c).addClass("active");$(".backstage-menu").addClass("active");$("#"+b).addClass(active);Conversations.inConversation()?($("#backstageTabHeaders").show(),$("#applicationMenuButton").show(),$("#roomToolbar").show()):($("#backstageTabHeaders").hide(),$("#applicationMenuButton").hide(),
$("#roomToolbar").hide());$(".dedicatedClose").click(hideBackstage);$("#masterLayout").css({opacity:Conversations.getCurrentConversationJid()?.3:0});Progress.call("onBackstageShow",[b])}
function hideBackstage(){$("html").css("overflow-y","hidden");$("#masterFooter").show();window.currentBackstage=noActiveBackstage;$(".backstage-menu").removeClass("active");$(".backstage").hide();$(".backstageTabHeader").removeClass(active);$(".backstage").removeClass(active);$("#applicationMenuButton").removeClass(active);$("#applicationMenuPopup").removeClass("active");$("#backstageTabHeaders").hide();$("#backstageContainer").hide();$("#hideBackstage").hide();$("#notices").show();$(".modeSpecificTool").removeClass(active);
hideSpinner();$("#masterLayout").css({opacity:1});"HealthCheckViewer"in window&&HealthCheckViewer.pause();Progress.call("onBackstageHide")}function showSpinner(){$("#loadingSlidePopup").show()}function hideSpinner(){$("#loadingSlidePopup").hide()}function toggleSubOptions(b){return function(){$(b).find(".backstageTabHeader").eq(0).click()}}
$(function(){var b=$("#heading"),a=progress().max(8);a.element.prependTo($("#progress"));a.value(0);b.text(sprintf("Logged in as %s",UserSettings.getUsername()));setupStatus();board=$("#board");boardContext=board[0].getContext("2d");b.text("Set up board");a.value(1);$("input.toolbar").addClass("commandModeInactive").addClass(commandMode?"commandModeActive":"commandModeInactive");$("#slideContainer button").addClass("commandModeInactive").addClass(commandMode?"commandModeActive":"commandModeInactive");
$("#up").click(bounceAnd(Extend.up));$("#down").click(bounceAnd(Extend.down));$("#left").click(bounceAnd(Extend.left));$("#right").click(bounceAnd(Extend.right));$("#in").click(bounceAnd(function(){Zoom["in"]()}));$("#out").click(bounceAnd(function(){Zoom.out()}));$("#drawMode").click(function(){Modes.currentMode!=Modes.draw&&Modes.draw.activate()});$("#selectMode").click(function(){Modes.currentMode!=Modes.select&&Modes.select.activate()});$("#insertText").click(function(){Modes.currentMode!=Modes.text&&
Modes.text.activate()});$("#panMode").click(function(){Modes.currentMode!=Modes.pan&&Modes.pan.activate()});$("#insertMode").click(function(){Modes.currentMode!=Modes.image&&(Modes.currentMode.deactivate(),Modes.image.activate())});$("#imageMode").click(function(){Modes.currentMode!=Modes.image&&Modes.image.activate()});$("#videoMode").click(function(){Modes.currentMode!=Modes.video&&Modes.video.activate()});$("#zoomMode").click(function(){Modes.currentMode!=Modes.zoom&&Modes.zoom.activate()});$("#feedbackMode").click(function(){Modes.currentMode!=
Modes.feedback&&Modes.feedback.activate()});$("#implicitlyExpanding").click(function(){implicitlyExpanding=$(this).is(":checked")});implicitlyExpanding&&$("#implicitlyExpanding").attr("checked",implicitlyExpanding);$("#showGrid").click(function(){showGrid=$(this).is(":checked");blit()});showGrid&&$("#showGrid").attr("checked",showGrid);a.value(2);$("#zoomToFull").click(bounceAnd(function(){zoomToFit()}));$("#zoomToPage").click(bounceAnd(function(){zoomToPage()}));$("#zoomToOriginal").click(bounceAnd(function(){zoomToOriginal()}));
$("#zoomToCurrent").click(bounceAnd(function(){takeControlOfViewbox(!0)}));window.currentBackstage=noActiveBackstage;$("#hideBackstage").click(bounceAnd(hideBackstage));$("#applicationMenuButton").click(function(){window.currentBackstage!=noActiveBackstage?hideBackstage():(showBackstage("integrations"),updateActiveMenu($("#menuIntegrations")))});loadSlidesAtNativeZoom="true"==UserSettings.getUserPref("loadSlidesAtNativeZoom");b=$("#loadSlidesAtNativeZoom");loadSlidesAtNativeZoom&&b.attr("checked",
!0);b.click(bounceAnd(function(){loadSlidesAtNativeZoom=$(this).is(":checked");UserSettings.setUserPref("loadSlidesAtNativeZoom",loadSlidesAtNativeZoom);receiveHistory(boardContent)}));b=function(b,a){var c=$("<div />");$("<div />",{text:sprintf("Choose your preferred %s",b)}).appendTo(c);a.map(function(a){return $("<div />").text(sprintf("%s px",a)).addClass("preferenceChoice").css({width:px(a),height:px(a)}).click(bounceAnd(function(){UserSettings.setUserPref(b,a);var c=Modes.currentMode;Modes.none.activate();
c.activate();Progress.call("onLayoutUpdated")})).appendTo(c)});return c};$("#preferencesContainerRight").append(b("subModeSize",[30,60])).append(b("thumbnailSize",[60,100,200]));$("#preferences").click(function(){showBackstage("preferences");$("#toggleHighQualityInk");$("#toggleHighQualityInk").attr("disabled","disabled")});$("input[name=renderQuality]").change(function(){var a=$("input[name=renderQuality]:checked").val();pressureSimilarityThreshold=parseInt(a);blit()});a.value(3);$("#submissionsButton").on("click",
function(){showBackstage("submissions");Submissions.reRender();updateActiveMenu($("#menuSubmissions"))});$("#gradesButton").on("click",function(){showBackstage("grades");Grades.reRender();updateActiveMenu($("#menuGrades"))});$("#quizzesButton").on("click",function(){showBackstage("quizzes");Quizzes.reRender();updateActiveMenu($("#menuPolls"))});$("#submitScreenshotButton").on("click",function(){"Submissions"in window&&Submissions.sendSubmission()});"Conversations"in window&&($("#enableSync").on("click",
Conversations.enableSyncMove),$("#disableSync").on("click",Conversations.disableSyncMove));_.each(subcategoryMapping,function(a,b){$("#"+b).click(toggleSubOptions(a))});a.value(7);Progress.stanzaReceived.boardOnLoad=actOnReceivedStanza;Modes.select.activate();$("#progress").hide();a.value(8);$("#updatePens").click(function(){showBackstage("customizeBrush");updateActiveMenu(this)});var c=!0,h=!0,d=!0;$("#menuPrint").click(function(){showBackstage("print");updateActiveMenu(this);var a=Conversations.getCurrentConversationJid(),
b=$("#rangeAll"),e=$("#rangeSpecified"),f=$("#rangeThisSlide"),n=$("#rangeSpecifiedInput"),z=$("#printButton"),u=$("#printPrivateNotes"),p=$("#printPageCount"),q=$("#printConversationTitle"),k=Conversations.getCurrentSlide().index+1,r=function(){_.forEach([e,b,f],function(a){a.prop("checked",!1)});n.prop("disabled",!0)};u.prop("checked",c);q.prop("checked",h);p.prop("checked",d);r();f.prop("checked",!0);n.val(k);var m=function(){z.attr("target","blank").attr("href",sprintf("clientSidePrintConversation?conversationJid=%s&pageRange=%s&includePrivateContent=%s&includeConversationTitle=%s&includePageCount=%s",
a,k,c,h,d))};m();b.unbind("click");b.on("click",function(){r();$(this).prop("checked",!0);k="all";m()});e.unbind("click");e.on("click",function(){r();$(this).prop("checked",!0);n.prop("disabled",!1);k=n.val();m()});n.unbind("change");n.on("change",function(){k=$(this).val();m()});f.unbind("click");f.on("click",function(){r();$(this).prop("checked",!0);k=Conversations.getCurrentSlide().index+1;m()});u.unbind("change");u.on("change",function(){c=$(this).prop("checked");m()});q.unbind("change");q.on("change",
function(){h=$(this).prop("checked");m()});p.unbind("change");p.on("change",function(){d=$(this).prop("checked");m()})});$("#menuGroups").click(function(){showBackstage("groups");updateActiveMenu(this)});$("#menuGrades").click(function(){showBackstage("grades");updateActiveMenu(this);Grades.reRender()});$("#menuSubmissions").click(function(){showBackstage("submissions");updateActiveMenu(this);Submissions.reRender()});$("#menuPolls").click(function(){showBackstage("quizzes");updateActiveMenu(this);
Quizzes.reRender()});$("#menuBlacklist").click(function(){showBackstage("blacklist");updateActiveMenu(this);Blacklist.reRender()});$("#menuSettings").click(function(){showBackstage("settings");updateActiveMenu(this)});$("#menuIntegrations").click(function(){showBackstage("integrations");updateActiveMenu(this)});$("#menuHelp").click(function(){showBackstage("help");updateActiveMenu(this)});$("#menuHealthCheck").click(function(){showBackstage("healthCheck");updateActiveMenu(this);"HealthCheckViewer"in
window&&HealthCheckViewer.resume()});$("#conversations").click(function(){window.location.href="/conversationSearch"});var v=$("#pasteDialogTemplate").clone();$("#pasteDialogTemplate").remove();var f=function(a){var b="dataTransfer"in a?a.dataTransfer:a.clipboardData;if("types"in b){var c=a.offsetX||10,d=a.offsetY||10,e=_.filter(b.types,function(a){return a.toLowerCase().startsWith("text")||a.toLowerCase().startsWith("image")||a.toLowerCase().startsWith("file")}),f=_.toArray(b.items),h=_.toArray(b.files),
p={items:f,files:h,types:e},q=_.map(e,function(a){return{key:a,value:b.getData(a)}}),k=function(a,c,d){a=_.find(a,c);void 0!=a&&null!=a&&d(a,b.getData(a))};console.log("Data transfer - availableTypes:",e,f,h);if(1<_.size(e)){var f=sprintf("pasteEventHandler_%s",_.uniqueId()),h=v.clone().attr("id",f),k=h.find(".dialogOptions"),r=k.find(".dialogOption").clone();k.empty();var m=$.jAlert({title:"Data to paste",content:h[0].outerHTML,closeOnClick:!0,closeOnEsc:!0,blurBackground:!0}),y=[{key:function(a){return"text/html"==
a},name:"rich text and images",faClass:"fa-file-code-o",onClick:function(a){var b=_.find(q,function(b){return b.key==a}).value,e=$(b),g=0,b=_.join(_.map(e,function(a){return a.outerHTML}),"");_.forEach(e.find("img"),function(a){try{Modes.image.handleDroppedSrc(a.src,c,d+g),g+=Math.max(a.height,50)}catch(b){errorAlert("Error dropping image","The source server you're dragging the image from does not want to allow dragging the image directly.  You may need to download the image first and then upload it.  "+
b)}});1<e.text().trim().length&&Modes.text.handleDrop(b,c,d+g)}},{key:function(a){return"text/plain"==a},name:"plain text",faClass:"fa-file-text-o",onClick:function(a){var b=_.find(q,function(b){return b.key==a}).value;Modes.text.handleDrop(b,c,d)}},{key:function(a){return"Files"==a},name:"files or images",faClass:"fa-file-o",onClick:function(a){Modes.image.handleDrop(p,c,d)}},{key:function(a){return 0==a.indexOf("image/")},name:"images",faClass:"fa-file-image-o",onClick:function(a){Modes.image.handleDrop(p,
c,d)}}];$("#"+f).find(".dialogOptions").html(_.map(_.filter(e,function(a){return _.some(y,function(b){return b.key(a)})}),function(a){var b=_.find(y,function(b){return b.key(a)}),c=r.clone(),d=c.find("button");d.addClass(b.faClass);d.on("click",function(){b.onClick(a);m.closeAlert()});d.find(".icon-txt").text(b.name);return c}))}else{var t=!1;k(e,function(a){return"Files"==a},function(a,e){t||(Modes.image.handleDrop(b,c,d),t=!0)});k(e,function(a){return 0==a.indexOf("image")},function(a,e){t||(Modes.image.handleDrop(b,
c,d),t=!0)});k(e,function(a){return"text/html"==a},function(a,b){if(!t){var e=$(b),g=0;b=_.join(_.map(e,function(a){return a.outerHTML}),"");_.forEach(e.find("img"),function(a){try{Modes.image.handleDroppedSrc(a.src,c,d+g),g+=Math.max(a.height,50)}catch(b){errorAlert("Error dropping image","The source server you're dragging the image from does not want to allow dragging the image directly.  You may need to download the image first and then upload it.  "+b)}});1<e.text().trim().length&&Modes.text.handleDrop(b,
c,d+g);t=!0}});k(e,function(a){return 0==a.indexOf("text")},function(a,b){t||(Modes.text.handleDrop(b,c,d),t=!0)});t||console.log("Data transfer - unknown type",b)}a.preventDefault();return!1}return!0};window.addEventListener("paste",function(a){return"originalEvent"in a?f(a.originalEvent):f(a)});$("#board").on("drop",function(a){return"originalEvent"in a?f(a.originalEvent):!1});(new Clipboard(".deeplink",{text:function(a){return $(a.nextElementSibling).find("a")[0].href}})).on("success",function(a){alert("Link copied to clipboard")}).on("error",
function(a){console.error("Action:",a.action);console.error("Trigger:",a.trigger)});var e=function(a){a.preventDefault();return!1};$(document).on("drop",e);window.onbeforepaste=e;_.forEach(["dragover","dragleave","dragenter"],function(a){window["on"+a]=e;$(window).on(a,e);$("#board")[0]["on"+a]=e;$("#board").on(a,e)})});
