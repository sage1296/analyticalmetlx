var RecycleBin=function(){var f=[],g=[],d={},k={},c=function(){void 0!=WorkQueue&&WorkQueue.enqueue(function(){d.jsGrid("loadData");var a=d.jsGrid("getSorting");"field"in a&&d.jsGrid("sort",a)})};$(function(){d=$("#recycleBinDatagrid");k=d.find(".actionButtons").clone();d.empty();var a=function(a){jsGrid.Field.call(this,a)};a.prototype=new jsGrid.Field({sorter:function(a,b){return new Date(a)-new Date(b)},itemTemplate:function(a){return(new Date(a)).toLocaleString()},insertTemplate:function(a){return""},
editTemplate:function(a){return""},insertValue:function(){return""},editValue:function(){return""}});jsGrid.fields.dateField=a;d.jsGrid({width:"100%",height:"auto",inserting:!1,editing:!1,sorting:!0,paging:!0,noDataContent:"No deleted content",controller:{loadData:function(a){if("sortField"in a){var b=_.sortBy(h(),function(b){return b[a.sortField]});"sortOrder"in a&&"desc"==a.sortOrder&&(b=_.reverse(b));return b}return h()}},pageLoading:!1,fields:[{name:"url",type:"text",title:"Preview",readOnly:!0,
sorting:!1,itemTemplate:function(a,b){var e=$("<span/>",{text:"no preview"});if("type"in b){var d=sprintf("Deleted %s from %s at %s on page %s",b.type,b.author,new Date(b.timestamp),b.slide);if("ink"==b.type){if("canvas"in b)var c=b.canvas.toDataURL("image/png"),e=$("<img/>",{src:c,"class":"stanzaThumbnail",style:"max-height:50px;max-width:100%;cursor:zoom-in"},function(){$.jAlert({title:d,closeOnClick:!0,width:"90%",content:$("<img/>",{src:c})[0].outerHTML})});return e}if("image"==b.type)return c=
calculateImageSource(b),e=$("<img/>",{src:c,"class":"stanzaThumbnail",style:"max-height:50px;max-width:100%;cursor:zoom-in"}).on("click",function(){$.jAlert({title:d,closeOnClick:!0,width:"90%",content:$("<img/>",{src:c})[0].outerHTML})});if("text"==b.type)return e;if("multiWordText"==b.type){var f=$("<span/>"),g=100/_.maxBy(b.words,function(a){return a.size}).size;_.forEach(b.words,function(a){a=$("<span/>",{text:a.text}).css({color:a.color[0],"font-family":a.font,"font-style":a.italic?"italic":
"normal","font-weight":a.bold?"bold":"normal","text-decoration":a.underline?"underline":"normal","font-size":sprintf("%s%%",a.size*g)});f.append(a)});return f}}return e}},{name:"timestamp",type:"dateField",title:"When",readOnly:!0},{name:"author",type:"text",title:"Who",readOnly:!0},{name:"privacy",type:"text",title:"Privacy",readOnly:!0},{name:"identity",type:"text",title:"actions",readOnly:!0,sorting:!1,itemTemplate:function(a,b){var e=k.clone();e.find(".restoreContent").on("click",function(){undeleteStanza(b)});
e.find(".rowIdentity").text(a);return e}}]});d.jsGrid("sort",{field:"timestamp",order:"desc"});c()});var h=function(){var a=_.reject(f,function(a){return _.some(g,function(c){return c.elementType==a.type&&c.oldIdentity==a.identity&&c.timestamp>a.timestamp})});if(Conversations.shouldModifyConversation())return a;var c=UserSettings.getUsername();return _.filter(a,function(a){return a.author==c})},l=function(){f=[];g=[]},m=function(a,d){try{if("type"in a)switch(a.type){case "ink":prerenderInk(a);break;
case "multiWordText":"doc"in a&&(a=richTextEditorToStanza(a))}"identity"in a&&"type"in a&&(f.push(a),c())}catch(b){console.log("RecycleBin.onCanvasContentDeleted",b,a)}},n=function(a){void 0!=a&&"type"in a&&"undeletedCanvasContent"==a.type&&"elementType"in a&&"oldIdentity"in a&&(g.push(a),c())};Progress.onConversationJoin.RecycleBin=l;Progress.historyReceived.RecycleBin=function(a){try{"type"in a&&"history"==a.type&&(l(),_.forEach(a.deletedCanvasContents,function(a){m(a,!0)}),_.forEach(a.undeletedCanvasContents,
function(a){n(a)}),c())}catch(d){console.log("RecycleBin.historyReceivedFunction",d)}};Progress.onCanvasContentDeleted.RecycleBin=m;Progress.stanzaReceived.RecycleBin=n;$(function(){$("#menuRecycleBin").on("click",function(){showBackstage("recycleBin");c()})});return{getAllDeletedContent:function(){return h()},getRawDeletedContent:function(){return f},getUndeletedContent:function(){return g},reRender:c}}();
