var board=function(sa){var S=function(a,b){return void 0!=sa&&a in sa?sa[a]:b},A=$("<canvas/>"),x=A[0].getContext("2d"),Oa=$("<div/>"),h={images:{},highlighters:{},texts:{},multiWordTexts:{},inks:{}},ha=void 0;S("pressureSimilarityThreshold",32);var B=0,E=0,t=80,r=60,D=0,H=0,X=0,Y=0,Z=320,aa=240,ia=S("inkCoordinatePrecision",Math.pow(10,3));S("lineDrawingThreshold",25);var Pa=S("maxX",2147483647),Qa=S("maxY",2147483647),ca=[],ta=function(a){return a*(1<D/H/(D/H)?t/D:r/H)},ja=function(a){return a/
(1<D/H/(D/H)?t/D:r/H)},I=function(a,b){var c=ta(a)+B,k=ta(b)+E;return{x:c,y:k}},O=function(a,b){var c=ja(a-B),k=ja(b-E);return{x:c,y:k}},Ca=function(){var a=[["black","#000000",255],["red","#ff0000",255],["blue","#0000ff",255],["cyan","#00ffff",255],["green","#00ff00",255],["white","#ffffff",255],["dark grey","#666666",255],["yellow","#ffff00",255],["magenta","#ff00ff",255]],b=a[0],c=function(a){n=parseInt(a,10);if(isNaN(n))return"00";nValue=Math.max(0,Math.min(n,255));a=function(a){internalN=Math.max(0,
Math.min(a,15));return"0123456789ABCDEF".charAt(internalN)};return(a((n-n%16)/16)+a(n%16)).toLowerCase()},k=function(a,b){return parseInt(a.substring(b,b+2).toUpperCase(),16)};return{getAllNamedColors:function(){return _.map(a,function(a){return{name:a[0],rgb:a[1],alpha:a[2],red:k(a[1],1),green:k(a[1],3),blue:k(a[1],5)}})},getNameForColor:function(b){var f=b[0],g=b[1];return(b=_.find(a,function(a){return a[1]==f&&a[2]==g}))?b[0]:"#"+c(g)+f.substring(1,7)},getColorForName:function(d){if(0==d.indexOf("#")&&
7==d.length){var f=255,g=k(d,1),u=k(d,3),m=k(d,5);return[c(g)+c(u)+c(m),f]}return 0==d.indexOf("#")&&9==d.length?(f=k(d,1),g=k(d,3),u=k(d,5),m=k(d,7),[c(g)+c(u)+c(m),f]):(f=_.find(a,function(a){return a[0]==d}))?[f[1],f[2]]:[b[1],b[2]]}}}(),Da=function(){var a=["sans-serif","serif"],b=[12,14,16,18,20,30,42,60];return{getAllFamilies:function(){return _.map(a,function(a){return a})},getAllSizes:function(){return _.map(b,function(a){return a})}}}(),Ea=function(){var a=[{id:1,width:2,color:"#000000",
isHighlighter:!1},{id:2,width:5,color:"#FF0000",isHighlighter:!1},{id:3,width:8,color:"#00FF00",isHighlighter:!1},{id:4,width:10,color:"#666666",isHighlighter:!1},{id:5,width:30,color:"#FFFF00",isHighlighter:!0}],b=[2,4,5,8,10,16,30];return{getDefaultBrushes:function(){return _.map(a,function(a){return a})},getAllBrushSizes:function(){return _.map(b,function(a){return a})}}}(),C=function(){return{call:function(a,b){b=b||[];$.each(C[a],function(c,k){try{k.apply(k,b)}catch(d){console.log("exception",
a,c,d)}})},onPrivacyChanged:{},onConversationJoin:{},onSelectionChanged:{},onBoardContentChanged:{},onViewboxChanged:{},onLayoutUpdated:{},postRender:{},historyReceived:{},stanzaReceived:{},currentConversationJidReceived:{},currentSlideJidReceived:{},conversationDetailsReceived:{},newConversationDetailsReceived:{},conversationsReceived:{},syncMoveReceived:{},userGroupsReceived:{},usernameReceived:{},userOptionsReceived:{}}}(),U=function(a,b,c,k){var d=!1,f=function(a,b){return{shift:a.shiftKey,ctrl:a.ctrlKey,
alt:a.altKey,eraser:b}};$.each(a,function(a,u){var m=$(u);m.css({"touch-action":"none"});var h=!1,e={},p=function(a){var b=a.originalEvent.pointerId,d="pen"==a.originalEvent.pointerType&&5==a.originalEvent.button,l=m.offset(),f=a.pageX-l.left,l=a.pageY-l.top,c=a.originalEvent.pressure||.5,g=I(f,l),k=e[b]||{pointerId:b,pointerType:a.originalEvent.pointerType,eraser:d,points:[]};k.points.push({x:g.x,y:g.y,screenX:f,screenY:l,z:c});k.eraser=k.eraser||d;e[b]=k;1<_.size(e)&&(0==h&&_.each(e,function(a){a.points=
[_.last(a.points)]}),h=!0);return{pointerType:a.pointerType,eraser:k.eraser,x:f,y:l,z:c,worldPos:g}},z=function(a){var b=a.originalEvent.pointerId,l="pen"==a.originalEvent.pointerType&&5==a.originalEvent.button,f=m.offset(),c=a.pageX-f.left,f=a.pageY-f.top,g=a.originalEvent.pressure||.5,k=I(c,f);delete e[b];h&&0==_.size(e)&&(d=h=!1);return{pointerType:a.pointerType,eraser:l,x:c,y:f,z:g,worldPos:k}},w;try{w="pointerEnabled"in Navigator&&1==Navigator.pointerEnabled||void 0!=PointerEvent}catch(P){w=
!1}if(w){var L=function(){if(1<_.size(e)){K();var a=_.map(_.filter(e,function(a){return 0<_.size(a.points)}),function(a){var b=_.first(a.points);a=_.last(a.points);return[b,a]});e={};var b=_.meanBy(a,function(a){return a[0].x-a[1].x}),d=_.meanBy(a,function(a){return a[0].y-a[1].y});ua.translate(ja(b),ja(d));var b=_.min(_.map(a,function(a){return a[0].y})),l=_.max(_.map(a,function(a){return a[0].y})),d=_.min(_.map(a,function(a){return a[0].x})),f=_.max(_.map(a,function(a){return a[0].x})),b=l-b,d=
f-d,f=_.min(_.map(a,function(a){return a[1].y})),l=_.max(_.map(a,function(a){return a[1].y})),c=_.min(_.map(a,function(a){return a[1].x})),a=(_.max(_.map(a,function(a){return a[1].x}))-c+(l-f))/2;da.scale((d+b)/2/a)}};m.bind("pointerdown",function(a){var l=p(a);a.preventDefault();v.pause();1!=_.size(e)||h||(d=!0,b(l.x,l.y,l.z,l.worldPos,f(a,l.eraser)))});m.bind("pointermove",function(a){var b=p(a);a.preventDefault();(a.originalEvent.pointerType==a.POINTER_TYPE_TOUCH||"touch"==a.originalEvent.pointerType&&
1<_.size(e))&&L();1!=_.size(e)||h||d&&c(b.x,b.y,b.z,b.worldPos,f(a,b.eraser))});m.bind("pointerup",function(a){var b=z(a);v.gracefullyResume();a.preventDefault();d&&!h&&k(b.x,b.y,b.z,b.worldPos,f(a,b.eraser));d=!1});w=function(a){z(a);v.gracefullyResume();a.preventDefault();if(d){var b=a.offsetX;a=a.offsetY;e={};v.gracefullyResume();a=I(b,a);b=a.x;a=a.y;b<B?(K(),T.left()):b>=B+t?(K(),T.right()):a<E?(K(),T.up()):a>=E+r&&(K(),T.down());d=!1}d=!1};m.bind("pointerout",w);m.bind("pointerleave",w);m.bind("pointercancel",
w)}else{m.bind("mousedown",function(a){v.pause();var l=m.offset();a.preventDefault();d=!0;var c=a.pageX-l.left,l=a.pageY-l.top,g=I(c,l);b(c,l,.5,g,f(a))});m.bind("mousemove",function(a){if(d){var b=m.offset();a.preventDefault();var l=a.pageX-b.left,b=a.pageY-b.top;c(l,b,.5,I(l,b),f(a))}});m.bind("mouseup",function(a){v.gracefullyResume();a.preventDefault();if(d){var b=m.offset(),l=a.pageX-b.left,b=a.pageY-b.top,c=I(l,b);k(l,b,.5,c,f(a))}d=!1});var ka=function(a,b){v.gracefullyResume();var l=I(a,b),
f=l.x,l=l.y;f<B?(K(),T.left()):f>=B+t?(K(),T.right()):l<E?(K(),T.up()):l>=E+r&&(K(),T.down());d=!1};m.bind("mouseout",function(a){v.gracefullyResume();a.preventDefault();d&&ka(a.offsetX,a.offsetY);d=!1});var l,G=function(a){return{x:average(_.map(a,"x")),y:average(_.map(a,"y"))}},ba=function(a){var b=[],l=m.offset();$.each(a,function(a,d){b.push({x:d.pageX-l.left,y:d.pageY-l.top,identifier:d.identifier})});return b};m.bind("touchstart",function(a){v.pause();a.preventDefault();var c=ba(a.originalEvent.touches);
if(1==c.length){var c=c[0],g=I(c.x,c.y);d=!0;b(c.x,c.y,.5,g,f(a))}else l=G(c)});m.bind("touchmove",function(a){a.preventDefault();var b=ba(a.originalEvent.touches);switch(b.length){case 0:break;case 1:d&&(b=b[0],c(b.x,b.y,.5,I(b.x,b.y),f(a)));break;default:a=G(b);var b=a.x-l.x,g=a.y-l.y;l=a;K();ua.translate(-1*b,-1*g)}});m.bind("touchend",function(a){v.gracefullyResume();a.preventDefault();if(d){var b=m.offset(),l=a.originalEvent.changedTouches[0],c=l.pageX-b.left,b=l.pageY-b.top;0>c||0>b||c>D||b>
H?ka(c,b):k(c,b,.5,I(c,b),f(a))}d=!1});var W=1;m.bind("gesturechange",function(a){v.pause();a.preventDefault();d=!1;a=a.originalEvent.scale;K();da.scale(W/a);W=a});m.bind("gestureend",function(){v.gracefullyResume();W=1})}});return function(a){d=a}},Ga=function(a,b,c){var k=H/D,d={left:a.left,top:a.top,right:a.right,bottom:a.bottom,width:a.width,height:a.height};a.height/a.width>k?(d.height=a.width*k,c&&(b=a.height-d.height,"center"==c?d.top+=b/2:"bottom"==c&&(d.top+=b))):(d.width=a.height/k,b&&(c=
a.width-d.width,"center"==b?d.left+=c/2:"right"==b&&(d.left+=c)));d.right=d.left+d.width;d.bottom=d.top+d.height;return d},N=function(a,b){return"undefined"!=typeof a&&"undefined"!=typeof b?!(b[0]>a[2]||b[2]<a[0]||b[1]>a[3]||b[3]<a[1]):!1},la=function(a,b){var c,k,d,f;a.x<b.x?(c=a.x,d=b.x):(c=b.x,d=a.x);a.y<b.y?(k=a.y,f=b.y):(k=b.y,f=a.y);return{left:c,top:k,right:d,bottom:f,width:Math.abs(d-c),height:Math.abs(f-k)}},ma=function(a,b,c){b=la(b,c);c=$("#selectionAdorner");jQuery.contains(c,a)||c.append(a);
a.is(":visible")||a.show();a.css({left:F(b.left),top:F(b.top),width:F(b.width),height:F(b.height)})},va=function(a){var b=a.x,c=a.y;0>a.x&&(b=0);a.x>D&&(b=D);0>a.y&&(c=0);a.y>H&&(c=H);return{x:b,y:c}},Q=function(a){$.each("pointerdown pointermove pointerup pointerout pointerleave pointercancel mouseup mousemove mousedown touchstart touchmove touchend touchcancelled mouseout touchleave gesturechange gesturestart".split(" "),function(b,c){a.unbind(c)});v.gracefullyResume()},R=function(a){isNaN(a[0])||
(h.minX=Math.min(h.minX,a[0]));isNaN(a[1])||(h.minY=Math.min(h.minY,a[1]));isNaN(a[2])||(h.maxX=Math.max(h.maxX,a[2]));isNaN(a[3])||(h.maxY=Math.max(h.maxY,a[3]));h.width=h.maxX-h.minX;h.height=h.maxY-h.minY},ea=function(a){var b=!_.some(a.bounds,function(a){return isNaN(a)||1E4<a||-1E4>a}),c="size"in a?!isNaN(a.size):!0;a="text"in a?0<a.text.length:!0;return b&&c&&a},v=function(){var a=!0,b=[],c=!1,k=function(){var a=b.pop();a?(c=c||a(),k()):(c&&(V(),c=!1),"Conversations"in window&&Conversations.updateThumbnail(Conversations.getCurrentSlideJid()))},
d=void 0;return{pause:function(){d&&(window.clearTimeout(d),d=void 0);a=!1},gracefullyResume:function(){d&&(window.clearTimeout(d),d=void 0);d=setTimeout(function(){a=!0;k()},1E3)},enqueue:function(d){a?d()&&V():b.push(function(){return d()})}}}(),ua={pan:function(a,b){M.panViewboxRelative(t/D*a,r/H*b)},translate:function(a,b){M.translateViewboxRelative(t/D*a,r/H*b)}},da=function(){var a=function(a){var c=3*h.width,k=3*h.height,d=.1*D,f=.1*H,g=void 0,u=void 0,m=void 0,e=void 0;"width"in a&&(g=a.width,
g>c&&(g=c),g<d&&(g=d));"height"in a&&(u=a.height,u>k&&(u=k),u<f&&(u=f));"x"in a&&(m=a.x,g!=a.width&&(m+=(a.width-g)/2));"y"in a&&u&&(e=a.y,u!=a.height&&(e+=(a.height-u)/2));return{width:g,height:u,x:m,y:e}};return{scale:function(b,c){var k=t*b,d=r*b;c||(d=a({height:d,width:k}),k=d.width,d=d.height);M.scaleAndTranslateViewbox((t-k)/2+B,(r-d)/2+E,k,d)},zoom:function(b,c,k){var d=t*b;b*=r;c||(c=a({height:b,width:d}),d=c.width,b=c.height);d-=t;c=b-r;M.zoomAndPanViewboxRelative(d/2*-1,c/2*-1,d,c,k)},out:function(){da.zoom(1.2)},
"in":function(){da.zoom(1/1.2)},constrainRequestedViewbox:a}}(),M=function(){var a=function(a,d,c,g,u,e){isNaN(a)||isNaN(d)||isNaN(c)||isNaN(g)?u&&u():(b&&b.stop(),b=!1,B=a,E=d,t=c,r=g,e||(X=B,Y=E,Z=t,aa=r),na(),fa(h),u&&u(),C.call("onViewboxChanged",[a,d,c,g]))},b,c=function(a,d,c,g,e,m,q){if(isNaN(a)||isNaN(d)||isNaN(c)||isNaN(g))e&&e();else{var y=B,p=E,z=t,w=r;q=a-y;var L=d-p,ka=c-z,l=g-w;b&&(b.stop(),b=!1);b=(new TWEEN.Tween({x:0,y:0,w:0,h:0})).to({x:q,y:L,w:ka,h:l},300).easing(TWEEN.Easing.Quadratic.Out).onUpdate(function(){B=
y+this.x;E=p+this.y;t=z+this.w;r=w+this.h}).onComplete(function(){b=!1;m||(X=B,Y=E,Z=t,aa=r);e&&e();C.call("onViewboxChanged",[a,d,c,g])}).start();var G=function(a){b&&(requestAnimationFrame(G),TWEEN.update(),na(),fa(h))};requestAnimationFrame(G)}};return{panViewbox:function(a,b,f,g){return c(a,b,t,r,f,g)},translateViewbox:function(b,d,c,g){return a(b,d,t,r,c,g)},zoomAndPanViewbox:function(a,b,f,g,e,h,q){return c(a,b,f,g,e,h,q)},scaleAndTranslateViewbox:function(b,c,f,g,e,h){return a(b,c,f,g,e,h)},
panViewboxRelative:function(a,b,f,g){return c(a+B,b+E,t,r,f,g)},translateViewboxRelative:function(b,c,f,g){return a(b+B,c+E,t,r,f,g)},zoomAndPanViewboxRelative:function(a,b,f,g,e,h){return c(a+B,b+E,f+t,g+r,e,h)},scaleAndTranslateViewboxRelative:function(b,c,f,g,e,h){return a(b+B,c+E,f+t,g+r,e,h)},changeViewbox:a,easeViewbox:c}}(),T=function(){return{up:function(){M.panViewboxRelative(0,-Math.floor(.6*r))},down:function(){M.panViewboxRelative(0,Math.floor(.6*r))},left:function(){M.panViewboxRelative(-Math.floor(.6*
t),0)},right:function(){M.panViewboxRelative(Math.floor(.6*t),0)},shift:M.panViewboxRelative,center:function(a,b,c){M.panViewboxRelative(a-t/2-B,b-r/2-E,c)}}}(),Sa=function(a){try{ha=parseInt(a.jid);Date.now();h=a;h.minX=0;h.minY=0;h.maxX=D;h.maxY=H;$.each(h.inks,function(a,b){oa(b)});Date.now();$.each(h.highlighters,function(a,b){oa(b)});Date.now();$.each(h.texts,function(a,b){ea(b)?pa(b):delete h.texts[b.id]});Date.now();_.each(h.multiWordTexts,function(a,b){var c=e.text.editorFor(a).doc;c.load(a.words);
a.bounds=c.calculateBounds();R(a.bounds)});Date.now();h.width=h.maxX-h.minX;h.height=h.maxY-h.minY;var b=function(){console.log("rendering:",a,h,x);Date.now();C.call("historyReceived",[a]);Date.now();Infinity==h.minX&&(h.minX=0);Infinity==h.minY&&(h.minY=0);X=h.minX;Y=h.minY;Z=h.width;aa=h.height;wa["default"]();console.log("startRender",X,Y,Z,aa);na();fa(h);Date.now();C.call("postRender",[h])};if(0==_.keys(h.images).length)_.defer(b);else{var c=0,k=_.keys(h.images).length;$.each(h.images,function(a,
f){f.bounds=[f.x,f.y,f.x+f.width,f.y+f.height];R(f.bounds);var g=new Image;f.imageData=g;var e=Ha(f,!0);g.onload=function(a){a=!1;0==f.width&&(f.width=g.naturalWidth,a=!0);0==f.height&&(f.height=g.naturalHeight,a=!0);a&&(f.bounds=[f.x,f.y,f.x+f.width,f.y+f.height],R(f.bounds));c+=1;xa(f);c>=k&&_.defer(b)};g.onerror=function(a){console.log("Data image load error",f,a);--k;console.log(sprintf("Preloaded %s/%s images",c,k));c>=k&&_.defer(b)};g.src=e})}}catch(d){console.log("receiveHistory exception",
d)}},Ta=_.once(function(){return{x:Pa,y:Qa}}),Ia=function(a,b){var c=a,k=b,d=1,f=1,g=Ta(),e=g.x,g=g.y;a>e&&(d=e/a,c=a*d);b>g&&(f=g/b,k=b*f);return{width:c,height:k,scaleX:d,scaleY:f}},oa=function(a){if(!ea(a))return a.identity in h.inks&&delete h.inks[a.identity],a.identity in h.highlighters&&delete h.highlighters[a.identity],!1;ga(a);R(a.bounds);var b=$("<canvas />")[0];a.canvas=b;var c=b.getContext("2d"),k=0,d="PRIVATE"==a.privacy.toUpperCase();d&&(k=3);var f=a.bounds[2]-a.bounds[0]+a.thickness+
2*k,g=a.bounds[3]-a.bounds[1]+a.thickness+2*k,e=Ia(f,g);b.width=e.width;b.height=e.height;$(b).css({width:F(f),height:F(g)});b=a.points;f=[];for(g=0;g<b.length;g+=3)f.push(b[g]*e.scaleX),f.push(b[g+1]*e.scaleY),f.push(b[g+2]);var m=-1*(a.minX-a.thickness/2-k)*e.scaleX,q=-1*(a.minY-a.thickness/2-k)*e.scaleY,y,p;if(d){y=f[0]+m;p=f[1]+q;c.lineWidth=a.thickness+k;c.strokeStyle=a.color[0];c.fillStyle=a.color[0];c.moveTo(y,p);c.beginPath();for(g=0;g<f.length;g+=3)c.moveTo(y,p),y=f[g]+m,p=f[g+1]+q,c.lineTo(y,
p);c.lineCap="round";c.stroke();c.closePath();c.strokeStyle="white";c.fillStyle="white"}else c.strokeStyle=a.color[0],c.fillStyle=a.color[0];y=f[0]+m;p=f[1]+q;c.moveTo(y,p);c.beginPath();y=f[0]+m;p=f[1]+q;_.each(_.chunk(f,3),function(b){c.beginPath();c.moveTo(y,p);y=b[0]+m;p=b[1]+q;c.lineTo(y,p);c.lineWidth=b[2]/256*a.thickness;c.lineCap="round";c.stroke()});return!0},Ja=function(a){a.bounds=[a.x,a.y,a.x+a.width,a.y+a.height]},Ha=function(a){var b="PRIVATE"==a.privacy.toUpperCase()?sprintf("%s%s",
a.slide,a.author):a.slide,c=sprintf,b=btoa(b);return c("/proxyImageUrl/%s?source=%s",b,encodeURIComponent(a.source.trim()))},ya=function(a){a.bounds=[a.x,a.y,a.x+a.width,a.y+a.runs.length*a.size*1.25]},ga=function(a){for(var b=Infinity,c=Infinity,k=-Infinity,d=-Infinity,f=[],g=a.points,e=0;e<g.length;e+=3){var h=Math.round(g[e]*ia)/ia,q=Math.round(g[e+1]*ia)/ia;g[e]=h;g[e+1]=q;f.push(g[e+2]);b=Math.min(h,b);c=Math.min(q,c);k=Math.max(h,k);d=Math.max(q,d)}a.minX=b;a.minY=c;a.maxX=k;a.maxY=d;a.width=
k-b;a.height=d-c;a.centerX=b+a.width/2;a.centerY=c+a.height/2;a.bounds=[b,c,k,d];a.widths=f},xa=function(a){var b=$("<canvas/>")[0];a.canvas=b;b.width=a.width;b.height=a.height;var c=.1*b.width,e=.1*b.height;b.width=a.width+c;b.height=a.height+e;var d=b.getContext("2d");d.drawImage(a.imageData,c/2,e/2,a.width,a.height);"PRIVATE"==a.privacy.toUpperCase()&&(d.globalAlpha=.2,d.fillStyle="red",d.fillRect(0,0,b.width,b.height),d.globalAlpha=1);delete a.imageData},pa=function(a){function b(a){var b=a.font;
"bold"==a.weight&&(b+=" bold");"italic"==a.style&&(b+=" italic");return b}var c=$("<canvas />")[0];a.canvas=c;var e=c.getContext("2d");e.strokeStyle=a.color;e.font=a.font;var d=/\n/;a.width||(a.width=Math.max.apply(Math,a.text.split(d).map(function(a){return e.measureText(a).width})));var f="",g=[],h=!1;$.each(a.text.split(""),function(b,c){c.match(d)?(g.push(""+f),f=""):h&&" "==c?(g.push(f),f=""):(h=e.measureText(f).width>=a.width-80,f+=c)});g.push(f);g=g.map(function(a){return a.trim()});a.runs=
g;ya(a);var m=a.bounds[3]-a.bounds[1],q=Ia(a.bounds[2]-a.bounds[0],m);c.width=q.width;c.height=q.height;a.height=m;"PRIVATE"==a.privacy.toUpperCase()&&(e.globalAlpha=.2,e.fillStyle="red",e.fillRect(0,0,q.width,q.height),e.globalAlpha=1);e.fillStyle=a.color[0];e.textBaseline="top";$.each(a.runs,function(c,d){var f=function(){var b=_.range(a.size,a.height,a.height/(a.height/(1.25*a.size)));_.each(b,function(b){e.beginPath();e.strokeStyle=a.color[0];b=0+b;e.moveTo(0,b);e.lineTo(0+q.width,b);e.stroke()})},
g=c*a.size*1.25;e.font=b(a);e.fillText(d,0*q.scaleX,(0+g)*q.scaleY,q.width);"underline"==a.decoration&&f()});R(a.bounds)},fa=function(a){if(a){Date.now();try{var b=[B,E,B+t,E+r];ca=[];var c=function(a){void 0!=a&&$.each(a,function(a,c){try{N(c.bounds,b)&&Ka(c)}catch(d){console.log("ink render failed for",d,c.canvas,c.identity,c)}})},k=function(a){a&&$.each(a,function(a,c){c.bounds||(c.bounds=[c.x,c.y,c.x+c.width,c.y+c.height]);N(c.bounds,b)&&e.text.draw(c)})};Object.keys(a.images);na();Date.now();
$.each(a.images,function(a,c){try{N(c.bounds,b)&&La(c)}catch(g){console.log("image render failed for",g,c.identity,c)}});Date.now();(function(){c(a.highlighters);Date.now();$.each(a.texts,function(a,c){N(c.bounds,b)&&Ma(c)});Date.now();k(a.multiWordTexts);Date.now();c(a.inks);Date.now();C.call("postRender",[h]);Date.now()})()}catch(d){console.log("Render exception",d)}C.call("onViewboxChanged")}},V=function(){try{fa(h)}catch(a){console.log("exception in render:",a)}},F=function(a){return sprintf("%spx",
a)},na=function(){x.clearRect(0,0,D,H)},wa=function(){var a=function(a,c,e,d){var f=!1;void 0==a?a=X:(f=!0,X=a);void 0==c?c=Y:(f=!0,Y=c);void 0==e?e=Z:(f=!0,Z=e);void 0==d?d=aa:(f=!0,aa=d);d=da.constrainRequestedViewbox({width:e,height:d,x:a,y:c});e=H/d.height;c=D/d.width;c>e?(a=d.height,e=d.width*c/e):(a=d.height/c*e,e=d.width);M.zoomAndPanViewbox(d.x,d.y,e,a,void 0,!f);C.call("onViewboxChanged")};return{specific:function(b,c,e,d){return a(b,c,e,d)},"default":function(){return a()}}}(),Va=function(a){if(0<
a.length){a=a.split(" ").map(function(a){return parseFloat(a)});for(var b={thickness:ta(e.draw.drawingAttributes.width),color:[e.draw.drawingAttributes.color,255],type:"ink",author:"",timestamp:Date.now(),target:"presentationSpace",privacy:Privacy.getCurrentPrivacy(),slide:ha.toString(),isHighlighter:e.draw.drawingAttributes.isHighlighter},c=[],k,d,f=0;f<a.length;f+=3)k=a[f],d=a[f+1],k=I(k,d),c=c.concat([k.x,k.y,a[f+2]]);b.points=c;b.checksum=b.points.reduce(function(a,b){return a+b},0);b.startingSum=
b.checksum;b.identity=b.checksum.toFixed(1);ga(b);b.isHighlighter?h.highlighters[b.identity]=b:h.inks[b.identity]=b;Ua(b)}},qa=function(){return{type:"moveDelta",identity:Date.now().toString(),author:"",slide:ha.toString(),target:"presentationSpace",privacy:Privacy.getCurrentPrivacy(),timestamp:Date.now(),inkIds:[],textIds:[],multiWordTextIds:[],imageIds:[],xOrigin:0,yOrigin:0,xTranslate:0,yTranslate:0,xScale:1,yScale:1,isDeleted:!1,newPrivacy:"not_set"}},Ua=function(a){updateStrokesPending(1,a.identity);
sendStanza(a)},Wa=function(a){var b=carota.runs.defaultFormatting,c;c=a.color||b.color;"string"==typeof c&&(c=[c,255]);var e=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(c[0]);c={alpha:c[1],red:parseInt(e[1],16),green:parseInt(e[2],16),blue:parseInt(e[3],16)};return{text:a.text,color:c,size:a.size||b.size,font:a.font||b.font,justify:a.align||b.align,bold:!0===a.bold,underline:!0===a.underline,italic:!0===a.italic}},za=function(a){if(a.doc){e.text.echoesToDisregard[a.identity]=!0;var b=sendStanza,
c=a.doc.calculateBounds(),h=a.doc.save();a={author:a.author,timestamp:-1,target:a.target,tag:"_",privacy:a.privacy,slide:a.slide,identity:a.identity,type:a.type,x:c[0],y:c[1],requestedWidth:c[2]-c[0],width:c[2]-c[0],height:c[3]-c[1],words:h.map(Wa)};b(a)}},Na={ink:Xa,dirtyInk:Ya,move:Za,moveDelta:$a,image:ab,text:bb,multiWordText:cb,command:db,submission:eb,attendance:fb,file:gb},gb=function(a){},fb=function(a){},eb=function(a){Submissions.processSubmission(a)},db=function(a){if("/TEACHER_VIEW_MOVED"==
a.command&&a.parameters[5]==ha){var b=a.parameters.map(parseFloat);_.some(b,isNaN)?console.log("Can't follow teacher to",a):b[4]!=DeviceConfiguration.getIdentity()&&"Conversations"in window&&Conversations.getIsSyncedToTeacher()}},cb=function(a){a.identity in e.text.echoesToDisregard||ea(a)&&void 0!=v&&v.enqueue(function(){e.text.editorFor(a).doc.load(a.words);V()})},bb=function(a){try{ea(a)?(h.texts[a.identity]=a,pa(a),R(a.bounds),void 0!=v&&v.enqueue(function(){return Aa(a.bounds)?(Ma(a),!1):!0})):
a.identity in h.texts&&delete h.texts[a.identity]}catch(b){console.log("textReceived exception:",b)}},$a=function(a){console.log("transformReceived",a);var b="",c=function(){var a=[void 0,void 0,void 0,void 0],b=function(){return a},c=function(b,c){void 0==b||isNaN(b)||(a[c]=b)};return{minX:b[0],setMinX:function(a){c(a,0)},minY:b[1],setMinY:function(a){c(a,1)},maxX:b[2],setMaxX:function(a){c(a,2)},maxY:b[3],setMaxY:function(a){c(a,3)},incorporateBounds:function(b){var c=function(c){var l=a[c];void 0==
l||isNaN(l)?a[c]=b[c]:a[c]=Math.max(l,b[c])},l=function(c){var l=a[c];void 0==l||isNaN(l)?a[c]=b[c]:a[c]=Math.min(l,b[c])};l(0);l(1);c(2);c(3)},getBounds:b,incorporateBoardBounds:function(){void 0!=a[0]&&void 0!=a[1]&&void 0!=a[2]&&void 0!=a[3]&&R(a)}}}();if("not_set"!=a.newPrivacy&&!a.isDeleted){var e=a.newPrivacy,b=b+("Became "+e);$.each(a.inkIds,function(a,b){var c=h.inks[b];c&&(c.privacy=e);if(c=h.highlighters[b])c.privacy=e});$.each(a.imageIds,function(a,b){h.images[b].privacy=e});$.each(a.textIds,
function(a,b){h.texts[b].privacy=e});$.each(a.multiWordTextIds,function(a,b){h.multiWordTextIds[b].privacy=e})}a.isDeleted&&(b+="deleted",e=a.privacy,$.each(a.inkIds,function(a,b){ra("highlighters",e,b);ra("inks",e,b)}),$.each(a.imageIds,function(a,b){var c=e;h.images[b].privacy.toUpperCase()==c.toUpperCase()&&delete h.images[b]}),$.each(a.textIds,function(a,b){var c=e;h.texts[b].privacy.toUpperCase()==c.toUpperCase()&&delete h.texts[b]}),$.each(a.multiWordTextIds,function(a,b){var c=e;h.multiWordTexts[b].privacy.toUpperCase()==
c.toUpperCase()&&delete h.multiWordTexts[b]}));if(1!=a.xScale||1!=a.yScale){var b=b+sprintf("scale (%s,%s)",a.xScale,a.yScale),d=[],f=[],g=[],u=[];$.each(a.inkIds,function(a,b){d.push(h.inks[b]);d.push(h.highlighters[b])});$.each(a.imageIds,function(a,b){u.push(h.images[b])});$.each(a.textIds,function(a,b){f.push(h.texts[b])});$.each(a.multiWordTextIds,function(a,b){g.push(h.multiWordTexts[b])});var m=0,q=0;if("xOrigin"in a&&"yOrigin"in a)m=a.xOrigin,q=a.yOrigin;else{var y=!0,p=function(a){y?(m=a.x,
q=a.y,y=!1):(a.x<m&&(m=a.x),a.y<q&&(q=a.y))};$.each(d,function(a,b){void 0!=b&&"bounds"in b&&1<_.size(b.bounds)&&p({x:b.bounds[0],y:b.bounds[1]})});$.each(f,function(a,b){void 0!=b&&"x"in b&&"y"in b&&p({x:b.x,y:b.y})});$.each(g,function(a,b){void 0!=b&&"x"in b&&"y"in b&&p({x:b.x,y:b.y})});$.each(u,function(a,b){void 0!=b&&"x"in b&&"y"in b&&p({x:b.x,y:b.y})})}c.setMinX(m);c.setMinY(q);$.each(d,function(b,d){if(d&&void 0!=d){var e=d.points,f=d.bounds[0],g=d.bounds[1],h,k,u=f-m;h=g-q;for(var u=-(u-u*
a.xScale),Ra=-(h-h*a.yScale),J=0;J<e.length;J+=3)h=e[J]-f,k=e[J+1]-g,e[J]=f+h*a.xScale+u,e[J+1]=g+k*a.yScale+Ra;ga(d);c.incorporateBounds(d.bounds)}});$.each(u,function(b,d){if(void 0!=d){d.width*=a.xScale;d.height*=a.yScale;var e=d.x-m,f=d.y-q,f=-(f-f*a.yScale);d.x+=-(e-e*a.xScale);d.y+=f;Ja(d);c.incorporateBounds(d.bounds)}});$.each(f,function(b,d){if(void 0!=d){d.width*=a.xScale;d.height*=a.yScale;var e=d.x-m,f=d.y-q,f=-(f-f*a.yScale);d.x+=-(e-e*a.xScale);d.y+=f;d.size*=a.yScale;d.font=sprintf("%spx %s",
d.size,d.family);ea(d)?(pa(d),ya(d)):d.identity in h.texts&&delete h.texts[d.identity];c.incorporateBounds(d.bounds)}});$.each(g,function(b,d){if(void 0!=d){d.width*=a.xScale;d.height*=a.yScale;var e=d.x-m,f=d.y-q,f=-(f-f*a.yScale);d.x+=-(e-e*a.xScale);d.y+=f;d.size*=a.yScale;d.font=sprintf("%spx %s",d.size,d.family);d.identity in h.multiWordTexts&&delete h.multiWordTexts[d.identity];c.incorporateBounds(d.bounds)}})}if(a.xTranslate||a.yTranslate){var z=a.xTranslate,w=a.yTranslate,b=b+sprintf("translate (%s,%s)",
z,w),L=function(a){if(a){for(var b=a.points,d=0;d<b.length;d+=3)b[d]+=z,b[d+1]+=w;ga(a);c.incorporateBounds(a.bounds)}};$.each(a.inkIds,function(a,b){L(h.inks[b]);L(h.highlighters[b])});$.each(a.imageIds,function(b,d){var e=h.images[d];e.x+=a.xTranslate;e.y+=a.yTranslate;Ja(e);c.incorporateBounds(e.bounds)});$.each(a.textIds,function(b,d){var e=h.texts[d];e.x+=a.xTranslate;e.y+=a.yTranslate;ya(e);c.incorporateBounds(e.bounds)});$.each(a.multiWordTextIds,function(b,d){var e=h.multiWordTexts[d],f=e.doc;
f.position.x+=a.xTranslate;f.position.y+=a.yTranslate;e.bounds=f.calculateBounds();c.incorporateBounds(e.bounds)})}c.incorporateBoardBounds();updateStatus(sprintf("%s %s %s %s %s",b,a.imageIds.length,a.textIds.length,a.multiWordTextIds.length,a.inkIds.length));V()},Za=function(a){updateStatus(sprintf("Moving %s, %s, %s",Object.keys(a.images).length,Object.keys(a.texts).length,Object.keys(a.inks).length));$.each(a.inks,function(a,c){h.inks[a]=c});$.each(a.images,function(a,c){h.images[a]=c});$.each(a.texts,
function(a,c){h.texts[a]=c});$.each(a.multiWordTexts,function(a,c){h.multiWordTexts[a]=c});V()},ra=function(a,b,c){c in h[a]&&h[a][c].privacy.toUpperCase()==b.toUpperCase()&&delete h[a][c]},Ya=function(a){var b=a.identity;a=a.privacy;ra("highlighters",a,b);ra("inks",a,b);updateStatus(sprintf("Deleted ink %s",b));V()},Aa=function(a){return!_.some(ca,function(b){return N(b,a)})},Ba=function(a){var b=O(a[0],a[1]);a=O(a[2],a[3]);return{screenPos:b,screenLimit:a,screenWidth:a.x-b.x,screenHeight:a.y-b.y}},
La=function(a){try{if(void 0!=a.canvas){var b=Ba(a.bounds);ca.push(a.bounds);var c=.1*b.screenWidth,e=.1*b.screenHeight;x.drawImage(a.canvas,b.screenPos.x-c/2,b.screenPos.y-e/2,b.screenWidth+c,b.screenHeight+e)}}catch(d){console.log("drawImage exception",d)}},Ma=function(a){try{var b=Ba(a.bounds);ca.push(a.bounds);x.drawImage(a.canvas,b.screenPos.x,b.screenPos.y,b.screenWidth,b.screenHeight)}catch(c){console.log("drawText exception",c)}},Ka=function(a){var b=Ba(a.bounds);ca.push(a.bounds);x.drawImage(a.canvas,
b.screenPos.x,b.screenPos.y,b.screenWidth,b.screenHeight)},ab=function(a){var b=new Image;a.imageData=b;b.onload=function(){0==a.width&&(a.width=b.naturalWidth);0==a.height&&(a.height=b.naturalHeight);a.bounds=[a.x,a.y,a.x+a.width,a.y+a.height];R(a.bounds);h.images[a.identity]=a;updateTracking(a.identity);xa(a);void 0!=v&&v.enqueue(function(){if(Aa(a.bounds)){try{La(a)}catch(b){console.log("drawImage exception",b)}return!1}console.log("Rerendering image in contested space");return!0})};b.src=Ha(a)},
Xa=function(a){ga(a);updateStrokesPending(-1,a.identity);oa(a)&&(R(a.bounds),a.isHighlighter?h.highlighters[a.identity]=a:h.inks[a.identity]=a,void 0!=v&&v.enqueue(function(){return Aa(a.bounds)?(Ka(a),!1):!0}))},K=function(){delete C.onBoardContentChanged.autoZooming},S={historyReceived:function(a){Sa(a)},stanzaReceived:function(a){try{a.type in Na?(Na[a.type](a),C.call("onBoardContentChanged")):console.log(sprintf("Unknown stanza: %s %s",a.type,a))}catch(b){console.log("Exception in receiveMeTLStanza",
b,a)}},progress:C,getCanvas:function(){return A},requestViewbox:function(a,b,c,e,d){M.changeViewbox(a,b,c,e,d)},resizeCanvas:function(a,b){var c=Math.round(a),e=Math.round(b),d=A[0].width,f=A[0].height;if(f!=e||d!=c)D=c,H=e,A.width=c,A.height=e,A[0].width=c,A[0].height=e,console.log("resizing canvas:",d,c,f,e,x),V()},worldToScreen:O,screenToWorld:I,scale:function(){return Math.min(D/t,H/r)},alertCanvas:function(a){var b=A[0],c=b.toDataURL();window.open(c,a,sprintf("width=%s, height=%s",b.width,b.height))},
getModes:function(){return e}},e=function(a){var b=function(){$(".activeTool").removeClass("activeTool");$(".activeMode").addClass("inactiveMode").removeClass("activeMode")},c=function(a,c){b();$(a).addClass("activeMode").removeClass("inactiveMode");$(".activeTool").removeClass("activeTool").addClass("inactiveTool");$(c).addClass("activeTool").removeClass("inactiveTool")},k={name:"none",activate:function(){e.currentMode.deactivate();e.currentMode=e.none;b()},deactivate:function(){b();Q(A)}};return{currentMode:k,
none:k,text:function(){var d=function(){},f,g,k,m,q,y,p,z,w,L,t,l,G,r=function(a){return e.text.editorFor({bounds:[a.x,a.y,a.x,a.y],identity:sprintf("%s_%s_%s","",Date.now(),_.uniqueId()),requestedWidth:300,width:0,height:0,x:a.x,y:a.y,type:"multiWordText",author:"",words:[]})};$(function(){f=$("#fontFamilySelector");g=$("#fontSizeSelector");k=$("#fontColorSelector");m=$("#fontBoldSelector");q=$("#fontItalicSelector");y=$("#fontUnderlineSelector");p=$("#justifySelector");z=$("#presetFitToText");w=
$("#presetRunToEdge");L=$("#presetNarrow");t=$("#presetWiden");G=$("#presetFullscreen");l=$("#presetCenterOnScreen");var a=f.find(".fontFamilyOption").clone(),b=g.find(".fontSizeOption").clone(),c=k.find(".fontColorOption").clone();Da.getAllFamilies().map(function(b){f.append(a.clone().attr("value",b).text(b))});Da.getAllSizes().map(function(a){g.append(b.clone().attr("value",a).text(a))});Ca.getAllNamedColors().map(function(a){k.append(c.clone().attr("value",a.rgb).text(a.name))});var d=function(a){return function(){_.each(h.multiWordTexts,
function(b){if(b.doc.isActive){var c=b.doc.selectedRange();c.setFormatting(a,!0!==c.getFormatting()[a]);0<b.doc.save().length&&za(b)}})}},e=function(a){return function(){var b=$(this).val();_.each(h.multiWordTexts,function(c){c.doc.isActive&&(c.doc.selectedRange().setFormatting(a,b),0<c.doc.save().length&&za(c))})}},J=function(a){return function(){_.each(h.multiWordTexts,function(b){if(b.doc.isActive){switch(a){case "runToEdge":var c=I(D,0);b.doc.width(c.x+B-b.x);break;case "fitToText":b.doc.width(b.doc.frame.actualWidth());
break;case "widen":b.doc.width(1.6*b.doc.frame.actualWidth());break;case "narrow":b.doc.width(.6*b.doc.frame.actualWidth());break;case "centerOnScreen":b.doc.width(I(D,0).x);b.doc.selectedRange().setFormatting("align","center");b.doc.position.x=B;break;case "fullscreen":b.doc.position.x=B,b.doc.position.y=E,b.doc.width(I(D,0).x),b.doc.select(0,b.doc.frame.length-1),b.doc.selectedRange().setFormatting("align","center"),b.doc.selectedRange().setFormatting("bold",!0),c=b.doc.documentRange().save(),c.push({text:"\n"}),
c.push({text:"\n"}),b.doc.load(c),c=b.doc.frame.length-1,b.doc.select(c,c)}b.doc.contentChanged.fire()}})}};m.click(d("bold"));q.click(d("italic"));y.click(d("underline"));f.change(e("font"));g.change(e("size"));k.change(e("color"));p.change(e("align"));z.click(J("fitToText"));w.click(J("runToEdge"));L.click(J("narrow"));t.click(J("widen"));l.click(J("centerOnScreen"));G.click(J("fullscreen"))});return{echoesToDisregard:{},editorFor:function(a){var b=h.multiWordTexts[a.identity];b||(b=h.multiWordTexts[a.identity]=
a);if(!b.doc){var c=""==a.author;b.doc=carota.editor.create($("<div />",{id:sprintf("t_%s",a.identity)}).appendTo(Oa)[0],A[0],c?function(){fa(h)}:d);c&&(b.doc.contentChanged(function(){var a=h.multiWordTexts[b.identity];a.privacy=Privacy.getCurrentPrivacy();a.target="presentationSpace";a.slide=Conversations.getCurrentSlideJid();0<b.doc.save().length&&za(a)}),b.doc.selectionChanged(function(a){a=a();m.toggleClass("active",1==a.bold);q.toggleClass("active",1==a.italic);y.toggleClass("active",1==a.underline);
g.val(a.size||carota.runs.defaultFormatting.size);f.val(a.font||carota.runs.defaultFormatting.font);k.val(a.color||carota.runs.defaultFormatting.color);p.val(a.align||carota.runs.defaultFormatting.align)}))}b.doc.position={x:a.x,y:a.y};b.doc.width(a.requestedWidth);return b},draw:function(b){b&&b.doc&&carota.editor.paint(A[0],b.doc,!0,a)},activate:function(){e.currentMode.deactivate();e.currentMode=e.text;c("#textTools","#insertText");$(".activeBrush").removeClass("activeBrush");C.call("onLayoutUpdated");
var a=Date.now();U(A,d,d,function(b,c,d,f){var g=[f.x-10,f.y-10,f.x+10,f.y+10];b=_.values(h.multiWordTexts).filter(function(a){var b=a.doc.calculateBounds();return N(b,g)&&""==a.author});_.each(h.multiWordTexts,function(a){a.doc.isActive=!1;0==a.doc.save().length&&delete h.multiWordTexts[a.identity]});console.log("Selected texts",b);0<b.length?(b=b[0].doc,b.isActive=!0,c=f.x-b.position.x,d=f.y-b.position.y,f=Date.now(),c=b.byCoordinate(c,d),b.mouseupHandler(c),500>=f-a&&b.dblclickHandler(c),a=f):
(f=r(f).doc,f.load([]),f.isActive=!0,f.mouseupHandler(f.byOrdinal(0)));C.historyReceived.ClearMultiTextEchoes=function(){e.text.echoesToDisregard={}};C.call("onSelectionChanged",[e.select.selected])})},deactivate:function(){b();_.each(h.multiWordTexts,function(a){a.doc.isActive=!1});Q(A);V()}}}(),image:function(){var a=void 0,f=function(){},g={},h=void 0,m=void 0,k=void 0,y=void 0,p=void 0,z=void 0,w=void 0,L=void 0,x=void 0,l=void 0,G=void 0,ba=[{name:"160*120",func:function(a,b){return{w:160,h:120}}},
{name:"320*240",func:function(a,b){return{w:320,h:240}}},{name:"25%",func:function(a,b){return{w:a/4,h:b/4}}},{name:"50%",func:function(a,b){return{w:a/2,h:b/2}}},{name:"75%",func:function(a,b){return{w:a/4*3,h:b/4*3}}},{name:"Native",func:function(a,b){return{w:a,h:b}}}],W=function(){if("type"in g&&"imageDefinition"==g.type){h.css({position:"absolute",left:F(g.screenX-30),top:F(g.screenY)});if("fileUpload"in g){k.hide();y.show();$.map(p.find(".imageSizeChoice"),function(a){"thumbnailSize"in g&&g.thumbnailSize.name==
$(a).text()?$(a).addClass("active"):$(a).removeClass("active")});var a=new FileReader;a.onload=function(a){"thumbnailSize"in g||(g.thumbnailSize=ba[0]);z[0].getContext("2d").clearRect(0,0,z.width(),z.height());var b=new Image;b.onload=function(a){var c=g.thumbnailSize.func(b.width,b.height);a=c.w;var c=c.h,d,e;a<c?(d=300,e=a/(c/300)):(e=300,d=c/(a/300));z.attr("width",e);z.attr("height",d);z.css({width:F(e),height:F(d)});z[0].getContext("2d").drawImage(b,0,0,e,d);L.text(g.x);x.text(g.y);l.text(a);
G.text(c);d=$("<canvas/>");d.attr("width",a);d.attr("height",c);d.css({width:F(a),height:F(c)});d[0].getContext("2d").drawImage(b,0,0,a,c);g.width=a;g.height=c;g.resizedImage=d[0].toDataURL();"resizedImage"in g&&w.show()};b.src=a.target.result};a.readAsDataURL(g.fileUpload);"resizedImage"in g?w.show():w.hide()}else k.show(),y.hide();h.show()}else P()},P=function(){h.hide();var a=k.wrap("<form>").closest("form").get(0);void 0!=a&&a.reset();void 0!=z[0]&&z[0].getContext("2d").clearRect(0,0,z.width(),
z.height());L.text("");x.text("");l.text("");G.text("");k.unwrap();g={};w.text("Upload").unbind("click").on("click",D)},D=function(){w.unbind("click").text("Uploading");if("type"in g&&"imageDefinition"==g.type&&"resizedImage"in g){v.pause();var a=Date.now(),b=sprintf("%s%s","",a),c=Conversations.getCurrentSlideJid(),d=sprintf("/uploadDataUri?jid=%s&filename=%s",c.toString(),encodeURI(b));$.ajax({url:d,type:"POST",success:function(d){updateTracking(b);var e=$(d).find("resourceUrl").text(),f={type:"image",
author:"",timestamp:a,tag:'{"author":"","privacy":"'+Privacy.getCurrentPrivacy()+'","id":"'+e+'","isBackground":false,"zIndex":0,"timestamp":-1}',identity:e,slide:c.toString(),source:$(d).text(),width:g.width,height:g.height,target:"presentationSpace",privacy:Privacy.getCurrentPrivacy(),x:g.x,y:g.y};P();updateTracking(e,function(){wa.specific(Math.min(f.x,B),Math.min(f.y,E),Math.max(f.x+f.width,t),Math.max(f.y+f.height,r))});sendStanza(f);v.gracefullyResume()},error:function(a){P();alert("Upload failed.  This image cannot be processed, either because of image protocol issues or because it exceeds the maximum image size.");
v.gracefullyResume()},data:g.resizedImage,cache:!1,contentType:!1,processData:!1})}},Fa=!1;$(function(){if(!Fa){Fa=!0;a=$("imageMarquee");h=$("#imageInsertOptions");m=$("#imageInsertOptionsClose");k=$("#imageFileChoice");y=$("#imageSizeControls");p=$("#imageSizeChoiceSelector");z=$("#imageUploadThumbnail");$("#imageProgressContainer");w=$("#imageUploadButton");L=$("#imageUploadX");x=$("#imageUploadY");l=$("#imageUploadWidth");G=$("#imageUploadHeight");m.on("click",P);k.attr("accept","image/*");void 0!=
k[0]&&k[0].addEventListener("change",function(a){"type"in g&&"imageDefinition"==g.type&&(a=(a.target.files||a.dataTransfer.files)[0],0==a.type.indexOf("image")&&(g.fileUpload=a,g.thumbnailSize=ba[0],W()))},!1);var b=p.find(".imageSizeChoice").clone();p.empty();ba.map(function(a){var c=b.clone().text(a.name).on("click",function(){"type"in g&&"imageDefinition"==g.type&&(g.thumbnailSize=a,W())});p.append(c)});P()}});return{activate:function(){e.currentMode.deactivate();e.currentMode=e.image;c("#imageTools",
"#insertImage");P();C.call("onLayoutUpdated");U(A,f,f,function(b,c,e,f){a.show();a.css({left:F(b),top:F(c)});P();b=O(f.x,f.y);g={type:"imageDefinition",screenX:b.x,screenY:b.y,x:f.x,y:f.y};W()})},deactivate:function(){P();Q(A);b()}}}(),pan:{name:"pan",activate:function(){updateStatus("PAN");e.currentMode.deactivate();c("#panTools","#panMode");e.currentMode=e.pan;var a,b;U(A,function(c,e,h){K();a=c;b=e},function(c,e,h){ua.translate(-1*(c-a),-1*(e-b));a=c;b=e},function(a,b,c){})},deactivate:function(){b();
Q(A)}},select:function(){var a=!1,f=function(){e.select.selected={images:{},text:{},inks:{},multiWordTexts:{}};C.call("onSelectionChanged",[e.select.selected])},g=_.debounce(function(){_.forEach(["images","texts","inks","highlighters","multiWordTexts"],function(a){var b="highlighters"==a?"inks":a;if(e&&e.select&&e.select.selected&&b in e.select.selected){var c=e.select.selected[b];_.forEach(c,function(d){c&&a in h&&d.identity in h[a]?c[d.identity]=h[a][d.identity]:"inks"==b?"highlighters"==a&&d.identity in
c&&1==c[d.identity].isHighlighter?delete c[d.identity]:"inks"==a&&d.identity in c&&0==c[d.identity].isHighlighter&&delete c[d.identity]:delete c[d.identity]})}});C.call("onSelectionChanged",[e.select.selected])},100),k=function(){if(void 0!=e.select.selected&&a){var b=e.select.selected;banContent(Conversations.getCurrentConversationJid(),Conversations.getCurrentSlideJid(),_.uniq(_.map(b.inks,function(a){return a.identity})),_.uniq(_.map(b.texts,function(a){return a.identity})),_.uniq(_.map(b.multiWordTexts,
function(a){return a.identity})),_.uniq(_.map(b.images,function(a){return a.identity})))}f()},m=function(){(a=Conversations.shouldModifyConversation()?!a:!1)?$("#administerContent").removeClass("disabledButton"):$("#administerContent").addClass("disabledButton");f()};C.onBoardContentChanged.ModesSelect=g;C.onViewboxChanged.ModesSelect=g;C.onSelectionChanged.ModesSelect=function(b){b&&(e.select.selected=b,"images"in b&&0<_.size(b.images)||"inks"in b&&0<_.size(b.inks)||"texts"in b&&0<_.size(b.texts)||
"multiWordTexts"in b&&0<_.size(b.multiWordTexts)?($("#delete").removeClass("disabledButton"),$("#resize").removeClass("disabledButton"),a?$("#ban").removeClass("disabledButton"):$("#ban").addClass("disabledButton")):($("#delete").addClass("disabledButton"),$("#resize").addClass("disabledButton"),$("#ban").addClass("disabledButton")),"Conversations"in window&&Conversations.shouldModifyConversation()?($("#ban").show(),$("#administerContent").show()):($("#ban").hide(),$("#administerContent").hide()),
a?$("#administerContent").removeClass("disabledButton"):$("#administerContent").addClass("disabledButton"),e.currentMode==e.select&&($("#selectionAdorner").empty(),_.forEach(["images","texts","inks","highlighters","multiWordTexts"],function(a){a in b&&$.each(b[a],function(a,b){var c=va(O(b.bounds[0],b.bounds[1])),d=va(O(b.bounds[2],b.bounds[3])),e=d.x-c.x,d=d.y-c.y;va(b.bounds[0],b.bounds[1],b.bounds[2],b.bounds[3]);$("#selectionAdorner").prepend($("<div />").addClass("selectionAdorner").css({left:c.x,
top:c.y,width:e,height:d}).data("originalWidth",e).data("originalHeight",d))})})))};C.historyReceived.ModesSelect=f;C.conversationDetailsReceived.ModesSelect=function(b){a&&Conversations.shouldModifyConversation()&&(a=!1);Conversations.shouldModifyConversation()?($("#ban").show(),$("#administerContent").show(),$("#administerContent").bind("click",m),$("#ban").bind("click",k)):($("#ban").hide(),$("#administerContent").hide(),$("#administerContent").unbind("click"),$("#ban").unbind("click"));a?$("#administerContent").removeClass("disabledButton"):
$("#administerContent").addClass("disabledButton")};return{name:"select",selected:{images:{},texts:{},inks:{},multiWordTexts:{}},clearSelection:f,activate:function(){e.currentMode.deactivate();e.currentMode=e.select;c("#selectTools","#selectMode");updateStatus("SELECT");var b={x:0,y:0},g,p,z,w=$("<div/>",{id:"selectMarquee"}),t=$("#selectionAdorner"),r=!1,l=!1;$("#delete").bind("click",function(){if(void 0!=e.select.selected){var a=qa();a.isDeleted=!0;"inks"in e.select.selected&&(a.inkIds=_.keys(e.select.selected.inks));
"texts"in e.select.selected&&(a.textIds=_.keys(e.select.selected.texts));"images"in e.select.selected&&(a.imageIds=_.keys(e.select.selected.images));"multiWordTexts"in e.select.selected&&(a.multiWordTextIds=_.keys(e.select.selected.multiWordTexts));sendStanza(a)}f()});var G=[0,0,0,0];$("#administerContent").bind("click",m);$("#ban").bind("click",k);$("#resize").bind("click",function(){var a=_.flatten([_.values(e.select.selected.images),_.values(e.select.selected.texts),_.values(e.select.selected.inks),
_.values(e.select.selected.multiWordTexts)]);if(0<a.length){var b=Math.min.apply(Math,a.map(function(a){return a.bounds[0]})),c=Math.min.apply(Math,a.map(function(a){return a.bounds[1]})),d=Math.max.apply(Math,a.map(function(a){return a.bounds[2]})),a=Math.max.apply(Math,a.map(function(a){return a.bounds[3]})),b=O(b,c),d=O(d,a).x,b=b.y;G=[d-30,b-30,d+30,b+30];t.append($("<img />",{src:"/static/images/resize.png","class":"resizeHandle"}).css({width:F(30),height:F(30),position:"absolute",left:F(d),
top:F(b)}))}});var x=function(a){a("images");a("texts");a("multiWordTexts");a("inks")},l=r=!1;U(A,function(a,c,d,f,h){r=l=!1;b={x:a,y:c};g=a;p=c;var k=[f.x-10,f.y-10,f.x+10,f.y+10];N(G,[a-10,c-10,a+10,c+10])?(updateStatus("Resizing"),l=!0):h.ctrl||(r=_.some(["images","texts","inks","multiWordTexts"],function(a){return _.some(e.select.selected[a],function(a){return a?N(a.bounds,k):!1})}));z=f;r?updateStatus("SELECT -> DRAG"):l?updateStatus("SELECT -> RESIZE"):(t.empty(),t.append(w),w.show(),ma(w,b,
b))},function(a,c,d,e,f){d={x:a,y:c};var h=a-g,k=c-p;g=a;p=c;if(l){var m=a/G[0],u=m;f.ctrl&&(u=c/G[0]);updateStatus(sprintf("Resizing %s%%",100*m));$(".selectionAdorner").map(function(){var a=$(this);a.css({width:a.data("originalWidth")*m,height:a.data("originalHeight")*u})})}else r?$(".selectionAdorner").map(function(){var a=$(this),b=F(parseInt(a.css("left"))+h),c=F(parseInt(a.css("top"))+k);a.css({left:b,top:c})}):ma(w,b,d)},function(b,c,f,g,k){v.gracefullyResume();if(r)k=qa(),k.xTranslate=g.x-
z.x,k.yTranslate=g.y-z.y,k.inkIds=_.keys(e.select.selected.inks),k.textIds=_.keys(e.select.selected.texts),k.imageIds=_.keys(e.select.selected.images),k.multiWordTextIds=_.keys(e.select.selected.multiWordTexts),r=!1,sendStanza(k);else if(l){g=qa();b/=G[0];var m=Infinity,u=Infinity;_.forEach(e.select.selected.inks,function(a){m=Math.min(a.bounds[0]);u=Math.min(a.bounds[1])});_.forEach(e.select.selected.texts,function(a){m=Math.min(a.bounds[0]);u=Math.min(a.bounds[1])});_.forEach(e.select.selected.images,
function(a){m=Math.min(a.bounds[0]);u=Math.min(a.bounds[1])});_.forEach(e.select.selected.multiWordTexts,function(a){m=Math.min(a.bounds[0]);u=Math.min(a.bounds[1])});g.xOrigin=m;g.yOrigin=u;g.inkIds=_.keys(e.select.selected.inks);g.textIds=_.keys(e.select.selected.texts);g.imageIds=_.keys(e.select.selected.images);g.multiWordTextIds=_.keys(e.select.selected.multiWordTexts);g.xScale=b;g.yScale=k.ctrl?c/G[0]:b;sendStanza(g);l=!1}else{c=la(z,g);var q=[c.left,c.top,c.right,c.bottom],p={images:{},texts:{},
inks:{},multiWordTexts:{}},y={};x(function(b){$.each(h[b],function(c,e){if(!("bounds"in e)&&"type"in e)switch(e.type){case "text":pa(e);break;case "image":xa(e);break;case "ink":oa(e);break;default:e.bounds=[NaN,NaN,NaN,NaN]}var f=e.bounds,f=Math.abs(.5*(f[2]-f[0])*(f[3]-f[1])),g;g=e.bounds;g=N(q,g)?(Math.max(q[0],g[0])-Math.min(q[2],g[2]))*(Math.max(q[1],g[1])-Math.min(q[3],g[3])):0;g>=f&&(incrementKey(y,e.author),a?""!=e.author&&(p[b][e.identity]=e):""==e.author&&(p[b][e.identity]=e))})});$.each(h.highlighters,
function(b,c){N(c.bounds,q)&&(incrementKey(y,c.author),a?""!=c.author&&(p.inks[c.identity]=c):""==c.author&&(p.inks[c.identity]=c))});k.ctrl?x(function(a){$.each(p[a],function(b,c){b in e.select.selected[a]?delete e.select.selected[a][b]:e.select.selected[a][b]=c})}):e.select.selected=p;var t=sprintf("Selected %s images, %s texts, %s inks, %s rich texts ",_.keys(e.select.selected.images).length,_.keys(e.select.selected.texts).length,_.keys(e.select.selected.inks).length);$.each(y,function(a,b){t+=
sprintf("%s:%s ",a,b)});updateStatus(t)}C.call("onSelectionChanged",[e.select.selected]);w.css({width:0,height:0}).hide()})},deactivate:function(){Q(A);b();f();$("#delete").unbind("click");$("#resize").unbind("click");$("#selectionAdorner").empty();$("#selectMarquee").hide();$("#administerContent").unbind("click");$("#ban").unbind("click")}}}(),zoom:{name:"zoom",activate:function(){e.currentMode.deactivate();e.currentMode=e.zoom;c("#zoomTools","#zoomMode");var a=$("<div />",{id:"zoomMarquee"}),b,
g={x:0,y:0};U(A,function(c,e,h,k){K();b=k;a.show();a.appendTo($("#selectionAdorner"));g={x:c,y:e};ma(a,g,g)},function(b,c,e,f){b={x:b,y:c};c=la(b,g);e="left";f="top";b.x==c.left&&(e="right");b.y==c.top&&(f="bottom");b=Ga(c,e,f);ma(a,{x:b.right,y:b.bottom},{x:b.left,y:b.top})},function(c,e,g,h){v.gracefullyResume();a.hide();c={x:0+h.x,y:0+h.y};e=la(c,{x:0+b.x,y:0+b.y});g="left";h="top";c.x==e.left&&(g="right");c.y==e.top&&(h="bottom");c=Ga(e,g,h);wa.specific(c.left,c.top,c.width,c.height)})},deactivate:function(){b();
$("#zoomMarquee").remove();Q(A)}},feedback:function(){var a=function(){switch(currentBackstage){case "quizzes":$("#quizzesButton").addClass(active);break;case "submissions":$("#submissionButton").addClass(active)}};C.onConversationJoin.setConversationRole=function(){a()};C.conversationDetailsReceived.respectNewPermissions=a;return{name:"feedback",activate:function(){e.currentMode.deactivate();e.currentMode=e.feedback;a();c("#feedbackTools","#feedbackMode");U(A,function(a,b,c,d){},function(a,b,c,d){},
function(a,b,c,d){});a()},deactivate:function(){b();Q(A);C.call("onLayoutUpdated")}}}(),draw:function(){var a=Ea.getDefaultBrushes(),f,g=!1,k=!1;return{name:"draw",brushes:_.map(a,function(a){return _.clone(a)}),activate:function(){if(e.currentMode!=e.draw){e.currentMode.deactivate();e.currentMode=e.draw;var b=function(){},q=void 0,t=void 0,p=function(a){e.draw.brushes[a.index]=a};$(".activeBrush").removeClass("activeBrush");var r=function(){var a=$("#drawTools");_.each(a.find(".pen"),function(a,
c){var d=e.draw.brushes[c],h=$(a).css({color:d.color}).click(function(){$(".activeBrush").removeClass("activeBrush");$(this).addClass("activeBrush");f=d;p(d);e.draw.drawingAttributes=f;g=!1;b(d)});h.find(".widthIndicator").text(d.width);d==f&&h.addClass("activeBrush")})},b=function(a){var c=$("#colors .dots"),d=$("#sizes .dots"),e=Ca.getAllNamedColors(),g=Ea.getAllBrushSizes();d.empty();g.map(function(c){var e=q.clone();d.append(e);e.click(function(){a.width=c;p(a);f=a;r();b(a)});var g=Canvas.circle(a.color,
c,50);c==a.width&&e.addClass("activeTool");e.prepend(g);g=c.toString()+"px";e.find(".sizeDotName").append(g)});c.empty();e.map(function(d){var e=t.clone();c.append(e);e.on("click",function(){a.color=d.rgb;f=a;p(a);r();b(a)});e.css("color",d.rgb);"rgb"in d&&d.rgb==a.color&&e.addClass("activeTool");var g=d.name;e.find(".colorDotName").append(g)});e=$("#setPenToHighlighter").unbind("click").on("click",function(){a.isHighlighter=!0;f=a;p(a);r();b(a)});g=$("#setPenToPen").unbind("click").on("click",function(){a.isHighlighter=
!1;f=a;p(a);r();b(a)});"isHighlighter"in f&&f.isHighlighter?(e.addClass("activeTool").addClass("active"),g.removeClass("activeTool").removeClass("active")):(g.addClass("activeTool").addClass("active"),e.removeClass("activeTool").removeClass("active"));C.call("onLayoutUpdated")};$("#resetPenButton").empty().text("reset pen").click(function(){var c=_.find(a,function(a){return a.id==f.id});void 0!=c&&(f.width=c.width,f.color=c.color,f.isHighlighter=c.isHighlighter,r(),b(f))});if(!k){k=!0;q=$("#penSize .sizeDot").clone();
t=$("#penColor .colorDot").clone();f=e.draw.brushes[0];r();b(f);e.draw.drawingAttributes=f;var w=$("#drawTools");w.find(".eraser").click(function(a){$(".activeBrush").removeClass("activeBrush");$(this).addClass("activeBrush");g=!0});w.find(".advancedTools").on("click",function(){b(f);showBackstage("customizeBrush")})}c("#drawTools","#drawMode");var v=[],B=[];$(".activeBrush").removeClass("activeBrush");g?$("#drawTools").find(".eraser").addClass("activeBrush"):_.each($("#drawTools").find(".pen"),function(a,
b){b+1==f.id&&$(a).addClass("activeBrush")});U(A,function(a,b,c,d,f){B=[];g||f.eraser||(x.strokeStyle=e.draw.drawingAttributes.color,v=[a,b,256*c])},function(a,b,c,d,f){if(g||f.eraser){var k=[d.x-10,d.y-10,d.x+10,d.y+10];a=function(a){$.each(a,function(b,c){if(""==c.author&&N(c.bounds,k)){delete a[c.identity];B.push(c.identity);var d=c.bounds,e=O(d[0],d[1]),d=O(d[2],d[3]);x.fillRect(e.x,e.y,d.x-e.x,d.y-e.y)}})};x.globalAlpha=.4;x.fillStyle="red";a(h.inks);a(h.highlighters);x.globalAlpha=1}else d=
e.draw.drawingAttributes.width*c,x.beginPath(),x.lineCap="round",x.lineWidth=d,d=_.takeRight(v,3),x.moveTo(d[0],d[1]),x.lineTo(a,b),x.stroke(),v=v.concat([a,b,256*c])},function(a,b,c,d,f){g||f.eraser?(a=qa(),a.isDeleted=!0,a.inkIds=B,sendStanza(a)):(d=e.draw.drawingAttributes.width*c,x.lineWidth=d,x.beginPath(),x.lineWidth=d,x.lineCap="round",d=_.takeRight(v,3),x.moveTo(d[0],d[1]),x.lineTo(a,b),x.stroke(),v=v.concat([a,b,256*c]),Va(v.join(" ")))})}},deactivate:function(){$(".activeBrush").removeClass("activeBrush");
b();v.gracefullyResume();Q(A);"customizeBrushPopup"==window.currentBackstage&&window.hideBackstage()}}}(),erase:{activate:function(){e.currentMode.deactivate();e.currentMode=e.erase;U(A,function(a,b,c,e){},function(a,b,c,e){},function(a,b,c,e){})},deactivate:function(){Q(A)}}}}(S);return S};
