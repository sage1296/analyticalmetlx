var HealthChecker=function(){var b={},h=0,m=function(n,d,g){n in b||(b[n]=timedQueue(36E5));b[n].enqueue({instant:(new Date).getTime(),duration:g,success:d});t()},l=function(b){$("#healthStatus").attr("low",b?11:4).attr("high",b?12:8).attr("optimum",b?13:10)},k=function(){var b=(new Date).getTime(),d=p(),g="/reportLatency";"latency"in d&&(d=d.latency,g=sprintf("%s?minLatency=%s&maxLatency=%s&meanLatency=%s&sampleCount=%s",g,d.min,d.max,d.average,d.count));l(!0);$.ajax(g,{method:"GET",success:function(c){if(_.includes(c,
"<html"))window.location.href=g;else{l(!1);var f=new Date,d=JSON.parse(c);c=parseInt(d.serverWorkTime);var a=((new Date).getTime()-b-c)/2,d=d.serverTime;h=f.getTime()-(d+a);m("serverResponse",!0,c);m("latency",!0,a);_.delay(k,2E4)}},dataType:"text",error:function(){l(!0);m("latency",!1,((new Date).getTime()-b)/2);_.delay(k,2E4)}})},t=_.throttle(function(){var b=q(),d=p();HealthCheckViewer.refreshDisplays(b,d)},1E3),r=function(b){b?k():_.delay(k,2E4)},q=function(){return _.mapValues(b,function(b,d){var g=
{},c=Math.round((b.newest().instant()-b.oldest().instant())/100);if(_.isNaN(c)||1E3>c)c=1E3;_.forEach(b.items(),function(b){var d=Math.floor(b.instant/c)*c,a=g[d],a=a?a:{count:0,avg:void 0,successCount:0,min:void 0,max:void 0,instant:d};a.count+=1;b.success&&(a.successCount+=1);if(void 0===a.min||a.min>b.duration)a.min=b.duration;if(void 0===a.max||a.max<b.duration)a.max=b.duration;a.avg=void 0===a.avg?b.duration:(b.duration-a.avg)/a.count+a.avg;g[d]=a});return _.values(g)})},p=function(){return _.mapValues(b,
function(b,d){var g=b.items(),c=_.size(g),f=_.map(g,"duration"),h=(new Date).getTime()-1E4;if(0<c){var a=_.mean(_.map(_.takeRightWhile(g,function(a){return a.instant>h}),"duration"));if(_.isNaN(a)||0>a)a=0;return{name:d,count:c,max:_.max(f),min:_.min(f),average:_.mean(f),recent:a,successful:0==c||g[c-1].success,successRate:_.countBy(g,"success")[!0]/c}}})};$(function(){r(!0)});return{getTimeOffset:function(){return h},getServerTime:function(){return new Date((new Date).getTime()+h)},check:k,resumeHealthCheck:r,
pauseHealthCheck:function(){},addMeasure:m,getMeasures:function(){return _.mapValues(b,function(b){return b.items()})},getAggregatedMeasures:q,describeHealth:p}}(),augmentArguments=function(b){b[_.size(b)]=(new Date).getTime();return b},serverResponse=function(b){HealthChecker.addMeasure(b.command,b.success,b.duration);if("instant"in b){var h=b.instant,h=((new Date).getTime()-h-b.duration)/2;HealthChecker.addMeasure("latency",b.success,h)}"success"in b&&0==b.success&&(console.log(b),errorAlert(sprintf("error in %s",
b.command),b.response||"Error encountered"))},HealthCheckViewer=function(){var b=!1,h={};$("#healthCheckListing");var m={},l={},k=!1;$(function(){h=$("#healthCheckListing");m=h.find(".healthCheckItem").clone();h.empty()});var t=function(a){return _.filter(_.map(a,function(a){return{x:a.instant,y:a.count-a.successCount}}),function(a){return 0<a.y})},r=function(a){return _.map(a,function(a){return{x:a.instant,y:a.avg}})},q=function(a){return _.map(a,function(a){return{x:a.instant,y:a.min}})},p=function(a){return _.map(a,
function(a){return{x:a.instant,y:a.max}})},n=function(a){var b=(new Date).getTime();return _.map(a,function(a){a.instant=(a.instant-b)/1E3;return a})},d=function(a,b){if(!(a in l)){var e=n(b),d=m.clone(),c=$("<canvas />").addClass("healthCheckCanvas").css({"margin-top":"-20px"});d.html(c);h.append(d);d={title:{display:!0,text:a,padding:20},legend:{display:!1},scales:{yAxes:[{id:"durationAxis",scaleLabel:{display:!0,labelString:"time taken (ms)"},type:"linear",stacked:!1,display:!0,position:"left",
ticks:{}},{id:"errorAxis",scaleLabel:{display:!0,labelString:"errors"},type:"linear",stacked:!0,display:!0,position:"right",ticks:{beginAtZero:!0,min:0,stepSize:1}}],xAxes:[{type:"linear",position:"bottom",scaleLabel:{display:!0,labelString:"time (seconds)"},ticks:{beginAtZero:!0}}]},hover:{mode:"x-axis"},elements:{line:{fill:!1},bar:{fill:!0}}};e={type:"bar",data:{labels:_.map(e,"instant"),datasets:[{type:"line",label:"error count",data:t(e),fill:!0,borderColor:"rgba(0,0,0,0.5)",backgroundColor:"rgba(255,0,0,0.3)",
borderWidth:1,pointRadius:0,pointHoverRadius:3,pointHitRadius:5,lineTension:0,stepped:!0,yAxisID:"errorAxis"},{label:"min",type:"line",data:q(e),fill:!0,pointRadius:0,pointHoverRadius:3,pointHitRadius:5,borderColor:"rgba(155,197,61,1)",backgroundColor:"rgba(155,197,61,0.3)",borderWidth:1,lineTension:.1,yAxisID:"durationAxis"},{label:"avg",type:"line",data:r(e),fill:!0,pointRadius:0,pointHoverRadius:3,pointHitRadius:5,borderColor:"rgba(250,121,33,1)",backgroundColor:"rgba(250,121,33,0.3)",borderWidth:1,
lineTension:.1,yAxisID:"durationAxis"},{label:"max",type:"line",data:p(e),fill:!0,pointRadius:0,pointHoverRadius:3,pointHitRadius:5,borderColor:"rgba(229,89,52,1)",backgroundColor:"rgba(229,89,52,0.3)",borderWidth:1,lineTension:.1,yAxisID:"durationAxis"}]},options:d};c=new Chart(c[0].getContext("2d"),e);console.log("New chart",a);l[a]=c}},g=function(a){var b=10;a.latency&&(b-=Math.min(8,a.latency.recent/100));a.render&&(b-=Math.min(8,a.render.recent/20));_.isNaN(b)&&(b=0);$(".meters").css("background-color",
function(){return _.some(["latency","serverResponse"],function(b){return!(b in a)||void 0===a[b]||1>a[b].successRate})?"red":"transparent"}());var d=k;k=_.every(["latency","serverResponse"],function(b){return b in a&&void 0!==a[b]&&a[b].successful});d!=k&&blit();$("#healthStatus").prop({max:13,low:4,high:8,min:0,value:b})},c={},f=function(a){return a in c?c[a]:c[a]=$(a)},u=function(a,c){void 0!=WorkQueue&&WorkQueue.enqueue(function(){g(c)});if(b){var e=c.latency;void 0!==e?(f(".healthCheckSummaryLatencyContainer").show(),
f(".latencyAverage").text(parseInt(e.average)),f(".worstLatency").text(parseInt(e.min)),f(".bestLatency").text(parseInt(e.max)),f(".successRate").text(parseInt(100*e.successRate)),200<e.average?f(".latencyHumanReadable").text("poor"):50<e.average?f(".latencyHumanReadable").text("moderate"):20<e.average&&f(".latencyHumanReadable").text("good")):f(".healthCheckSummaryLatencyContainer").hide();e=c.serverResponse;void 0!==e?(f(".heathCheckSummaryServerResponseContainer").show(),e=e.average,f(".serverResponseAverage").text(parseInt(e)),
e=2<e?"poor":"good",f(".serverResponseHumanReadable").text(e)):f(".heathCheckSummaryServerResponseContainer").hide();_.forEach(a,function(a,b){var c=n(a);b in l||d(b,a);var e=l[b];e.data.datasets[0].data=t(c);e.data.datasets[1].data=q(c);e.data.datasets[2].data=r(c);e.data.datasets[3].data=p(c);e.update()})}};return{resume:function(){b=!0;var a=HealthChecker.getAggregatedMeasures(1E3),c=HealthChecker.describeHealth();u(a,c);_.forEach(a,function(a,b){d(b,a)})},pause:function(){b=!1},refreshDisplays:u,
healthy:function(){return k}}}();
